{% extends "base.html" %}
{% load customtags %}

{% block title %}Samples{% endblock %}

{% block content %}
<h4>List of Samples</h4>
<br>
<div>
    <table class="table table-sm table-hover table-bordered table-responsive-xl table-striped"
        id="{{ table_id }}"
        data-toggle="table"
        data-buttons-align="left"
        data-buttons-class="primary"
        data-buttons="customButtonsFunction"
        data-export-types="['csv', 'txt', 'excel']"
        data-export-data-type="all"
        data-filter-control="true"
        data-search="true"
        data-search-align="left"
        data-search-on-enter-key="true"
        data-search-text="{{ search_term }}"
        data-sort-name="{{ order_by }}"
        data-sort-order="{{ order_dir }}"
        data-show-search-clear-button="true"
        data-show-multi-sort="true"
        data-show-columns="true"
        data-show-columns-toggle-all="true"
        data-show-fullscreen="true"
        data-show-export="false">
        <thead>
            <tr>
                {{ name }}
                {{ animal__name }}
                {{ tissue__name }}
                {{ first_study }}
                {{ animal__genotype }}
                {{ infusate_name }}
                {{ first_tracer }}
                {{ first_tracer_conc }}
                {{ first_label }}
                {{ animal__infusion_rate }}
                {{ animal__treatment__name }}
                {{ animal__body_weight }}
                {{ age_weeks_str }}
                {{ animal__sex }}
                {{ animal__diet }}
                {{ animal__feeding_status }}
                {{ researcher }}
                {{ col_date_str }}
                {{ col_time_str }}
                {{ first_ms_operator }}
                {{ first_ms_date }}
                {{ first_ms_sample }}
            </tr>
        </thead>
        <tbody>
            {% for sample in sample_list %}
                <tr>
                    <td><a href="{% url 'sample_detail' sample.id %}">{{ sample.name }}</a></td>
                    <td><a href="{% url 'animal_detail' sample.animal.id %}">{{ sample.animal.name }}</a></td>
                    <td><a href="{% url 'tissue_detail' sample.tissue.id %}">{{ sample.tissue.name }}</a></td>
                    <td>
                        {# Hidden value for sorting #}
                        <span style="display:none">{{ sample.first_study }}</span>

                        {# Rendering performance of this template is dramatically improved by only rendering sample.first_study when the count is greater than 1. #}
                        {% if sample.animal.studies.count|gt:1 %}
                            {% if order_dir|lower == "asc" %}
                                {% for study in sample.studies.all|dictsort:"name" %}
                                    <a href="{% url 'study_detail' study.id %}">{{ study.name }}</a>{% if not forloop.last %};<br>{% endif %}
                                {% endfor %}
                            {% else %}
                                {% for study in sample.studies.all|dictsortreversed:"name" %}
                                    <a href="{% url 'study_detail' study.id %}">{{ study.name }}</a>{% if not forloop.last %};<br>{% endif %}
                                {% endfor %}
                            {% endif %}
                        {% elif sample.first_study %}
                            <a href="{% url 'study_detail' sample.first_study_id %}">{{ sample.first_study }}</a>
                        {% endif %}
                    </td>
                    <td>{{ sample.animal.genotype }}</td>
                    <td>
                        {% if sample.animal.infusate %}
                            <div class="newlines"><a href="{% url 'infusate_detail' sample.animal.infusate.id %}">{{ sample.animal.infusate.pretty_short_name }}</div>
                        {% endif %}
                    </td>
                    {% with ""|make_list as tracer_dicts %}
                        {% if sample.animal.infusate and sample.animal.infusate.tracer_links.count|gt:1 %}
                            {# Build a tracerlink dict and append it to tracer_dicts so we can sort both in individual columns #}
                            {% for tracer_link in sample.animal.infusate.tracer_links.all %}
                                {% createDict as tracerlink %}
                                {% addToDict tracerlink "compound_id" tracer_link.tracer.compound.id %}
                                {% addToDict tracerlink "name" tracer_link.tracer.name %}
                                {% addToDict tracerlink "conc" tracer_link.concentration|sigdig:4 %}
                                {% addToDict tracerlink "concval" tracer_link.concentration %}
                                {% append tracer_dicts tracerlink %}
                            {% endfor %}
                            <td>
                                {# Hidden value for sorting #}
                                <span style="display:none">{{ sample.first_tracer }}</span>

                                {% if order_by == "first_tracer" and order_dir|lower == "desc" %}
                                    {% for tracer in tracer_dicts|dictsortreversed:"name" %}
                                        <div class="nobr"><a href="{% url 'compound_detail' tracer.compound_id %}">{{ tracer.name }}</a>{% if not forloop.last %};<br>{% endif %}</div>
                                    {% endfor %}
                                {% elif order_by == "first_tracer_conc" and order_dir|lower == "desc" %}
                                    {% for tracer in tracer_dicts|dictsortreversed:"concval" %}
                                        <div class="nobr"><a href="{% url 'compound_detail' tracer.compound_id %}">{{ tracer.name }}</a>{% if not forloop.last %};<br>{% endif %}</div>
                                    {% endfor %}
                                {% elif order_by == "first_tracer_conc" and order_dir|lower == "asc" %}
                                    {% for tracer in tracer_dicts|dictsort:"concval" %}
                                        <div class="nobr"><a href="{% url 'compound_detail' tracer.compound_id %}">{{ tracer.name }}</a>{% if not forloop.last %};<br>{% endif %}</div>
                                    {% endfor %}
                                {% else %}
                                    {% for tracer in tracer_dicts|dictsort:"name" %}
                                        <div class="nobr"><a href="{% url 'compound_detail' tracer.compound_id %}">{{ tracer.name }}</a>{% if not forloop.last %};<br>{% endif %}</div>
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                {# Hidden value for sorting #}
                                <span style="display:none">{{ sample.first_tracer_conc }}</span>

                                {% comment %}
                                    Rendering performance of this template is dramatically improved by only rendering sample.first_tracer_conc when the count is greater than 1.
                                    This assumes that a single infusate/tracer pair has a single concentration/link.  This is currently true, though there are plans to make it a true many-to-many.
                                    See: https://github.com/Princeton-LSI-ResearchComputing/tracebase/issues/1053
                                {% endcomment %}
                                {% if order_by == "first_tracer" and order_dir|lower == "desc" %}
                                    {% for tracer in tracer_dicts|dictsortreversed:"name" %}
                                        <span title="{{ tracer.conc }}">{{ tracer.conc }}</span>{% if not forloop.last %};<br>{% endif %}
                                    {% endfor %}
                                {% elif order_by == "first_tracer_conc" and order_dir|lower == "desc" %}
                                    {% for tracer in tracer_dicts|dictsortreversed:"concval" %}
                                        <span title="{{ tracer.conc }}">{{ tracer.conc }}</span>{% if not forloop.last %};<br>{% endif %}
                                    {% endfor %}
                                {% elif order_by == "first_tracer_conc" and order_dir|lower == "asc" %}
                                    {% for tracer in tracer_dicts|dictsort:"concval" %}
                                        <span title="{{ tracer.conc }}">{{ tracer.conc }}</span>{% if not forloop.last %};<br>{% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% for tracer in tracer_dicts|dictsort:"name" %}
                                        <span title="{{ tracer.conc }}">{{ tracer.conc }}</span>{% if not forloop.last %};<br>{% endif %}
                                    {% endfor %}
                                {% endif %}
                            </td>
                        {% elif sample.animal.infusate %}  {# There is a single tracer infusate #}
                            <td><div class="nobr"><a href="{% url 'compound_detail' sample.first_tracer_compound_id %}">{{ sample.first_tracer }}</a></div></td>
                            <td><span title="{{ sample.first_tracer_conc }}">{{ sample.first_tracer_conc|sigdig:4 }}</span></td>
                        {% else %}
                            <td><span title="No tracers associated with the animal" class="text-muted">None</span></td>
                            <td><span title="No tracers associated with the animal" class="text-muted">None</span></td>
                        {% endif %}
                    {% endwith %}
                    <td>
                        {# Hidden value for sorting #}
                        <span style="display:none">{{ sample.first_label }}</span>

                        {# Rendering performance of this template is dramatically improved by only rendering sample.first_label when the count is greater than 1. #}
                        {% if sample.animal.labels.count|gt:1 %}
                            {% if order_dir|lower == "asc" %}
                                {% for label in sample.animal.labels.all|dictsort:"element" %}
                                    {{ label.element }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                {% for label in sample.animal.labels.all|dictsortreversed:"element" %}
                                    {{ label.element }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% elif sample.first_label %}
                            {{ sample.first_label }}
                        {% endif %}
                    </td>
                    <td>
                        {% if sample.animal.infusion_rate %}
                            <span title="{{ sample.animal.infusion_rate }}">{{ sample.animal.infusion_rate|sigdig:2 }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if sample.animal.treatment %}
                            <a href="{% url 'protocol_detail' sample.animal.treatment.id %}">{{ sample.animal.treatment.name }}</a>
                        {% endif %}
                    </td>
                    <td>{{ sample.animal.body_weight }}</td>
                    <td>{{ sample.age_weeks_str|default_if_none:'' }}</td>
                    <td>{{ sample.animal.sex }}</td>
                    <td>{{ sample.animal.diet }}</td>
                    <td>{{ sample.animal.feeding_status }}</td>
                    <td>{{ sample.researcher }}</td>
                    <td>{{ sample.col_date_str|default_if_none:'' }}</td>
                    <td>{{ sample.col_time_str|default_if_none:'' }}</td>
                        {% if sample.sequence_count|gt:1 %}
                            {% with seq_dicts=""|make_list %}
                                {% createDict as msrs_by_seq %}
                                {# Build a sequence dict and append it to seq_dicts so we can sort both in individual columns #}
                                {% for msrun_sample in sample.msrun_samples.all %}
                                    {% createDict as msrsdict %}
                                    {% addToDict msrsdict "msrunsample_id" msrun_sample.id %}
                                    {% addToDict msrsdict "polarity" msrun_sample.polarity|polarity_name_to_sign %}
                                    {% addToDict msrsdict "mz_min" msrun_sample.mz_min %}
                                    {% addToDict msrsdict "mz_max" msrun_sample.mz_max %}
                                    {% addToDict msrs_by_seq msrun_sample.msrun_sequence.id ""|make_list False %}
                                    {% append_unique msrs_by_seq|index:msrun_sample.msrun_sequence.id msrsdict %}

                                    {% createDict as sequence %}
                                    {% addToDict sequence "sequence_id" msrun_sample.msrun_sequence.id %}
                                    {% addToDict sequence "operator" msrun_sample.msrun_sequence.researcher %}
                                    {% addToDict sequence "date" msrun_sample.msrun_sequence.date|format_date:date_format %}
                                    {% append_unique seq_dicts sequence %}
                                {% endfor %}

                                <td>
                                    {% if order_by == "first_ms_operator" and order_dir|lower == "desc" %}
                                        {% for sequence in seq_dicts|dictsortreversed:"operator" %}
                                            <div class="nobr">{{ sequence.operator }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% elif order_by == "first_ms_date" and order_dir|lower == "desc" %}
                                        {% for sequence in seq_dicts|dictsortreversed:"date" %}
                                            <div class="nobr">{{ sequence.operator }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% elif order_by == "first_ms_date" and order_dir|lower == "asc" %}
                                        {% for sequence in seq_dicts|dictsort:"date" %}
                                            <div class="nobr">{{ sequence.operator }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% else %}
                                        {% for sequence in seq_dicts|dictsort:"operator" %}
                                            <div class="nobr">{{ sequence.operator }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order_by == "first_ms_operator" and order_dir|lower == "desc" %}
                                        {% for sequence in seq_dicts|dictsortreversed:"operator" %}
                                            <div class="nobr">{{ sequence.date }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% elif order_by == "first_ms_date" and order_dir|lower == "desc" %}
                                        {% for sequence in seq_dicts|dictsortreversed:"date" %}
                                            <div class="nobr">{{ sequence.date }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% elif order_by == "first_ms_date" and order_dir|lower == "asc" %}
                                        {% for sequence in seq_dicts|dictsort:"date" %}
                                            <div class="nobr">{{ sequence.date }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% else %}
                                        {% for sequence in seq_dicts|dictsort:"operator" %}
                                            <div class="nobr">{{ sequence.date }}{% if not forloop.last %};<br>{% endif %}</div>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order_by == "first_ms_operator" and order_dir|lower == "desc" %}
                                        {% for sequence in seq_dicts|dictsortreversed:"operator" %}
                                            <div class="nobr">
                                                {% for msrsample in msrs_by_seq|index:sequence.sequence_id %}
                                                    <a href="{% url 'msrunsample_detail' msrsample.msrunsample_id %}" style="display: inline-block;">MSRunSample Detail
                                                        {% if msrsample.polarity and msrsample.mz_min and msrsample.mz_max %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }} <span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% elif msrsample.polarity %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }})
                                                        {% elif msrsample.mz_min and msrsample.mz_max %}
                                                            (<span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% endif %}
                                                    </a>{% if not forloop.last %}<br>{% endif %}{% endfor %}{% if not forloop.last %};<br>{% endif %}
                                            </div>
                                        {% endfor %}
                                    {% elif order_by == "first_ms_date" and order_dir|lower == "desc" %}
                                        {% for sequence in seq_dicts|dictsortreversed:"date" %}
                                            <div class="nobr">
                                                {% for msrsample in msrs_by_seq|index:sequence.sequence_id %}
                                                    <a href="{% url 'msrunsample_detail' msrsample.msrunsample_id %}" style="display: inline-block;">MSRunSample Detail
                                                        {% if msrsample.polarity and msrsample.mz_min and msrsample.mz_max %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }} <span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% elif msrsample.polarity %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }})
                                                        {% elif msrsample.mz_min and msrsample.mz_max %}
                                                            (<span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% endif %}
                                                    </a>{% if not forloop.last %}<br>{% endif %}{% endfor %}{% if not forloop.last %};<br>{% endif %}
                                            </div>
                                        {% endfor %}
                                    {% elif order_by == "first_ms_date" and order_dir|lower == "asc" %}
                                        {% for sequence in seq_dicts|dictsort:"date" %}
                                            <div class="nobr">
                                                {% for msrsample in msrs_by_seq|index:sequence.sequence_id %}
                                                    <a href="{% url 'msrunsample_detail' msrsample.msrunsample_id %}" style="display: inline-block;">MSRunSample Detail
                                                        {% if msrsample.polarity and msrsample.mz_min and msrsample.mz_max %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }} <span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% elif msrsample.polarity %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }})
                                                        {% elif msrsample.mz_min and msrsample.mz_max %}
                                                            (<span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% endif %}
                                                    </a>{% if not forloop.last %}<br>{% endif %}{% endfor %}{% if not forloop.last %};<br>{% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        {% for sequence in seq_dicts|dictsort:"operator" %}
                                            <div class="nobr">
                                                {% for msrsample in msrs_by_seq|index:sequence.sequence_id %}
                                                    <a href="{% url 'msrunsample_detail' msrsample.msrunsample_id %}" style="display: inline-block;">MSRunSample Detail
                                                        {% if msrsample.polarity and msrsample.mz_min and msrsample.mz_max %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }} <span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% elif msrsample.polarity %}
                                                            ({{ msrsample.polarity|polarity_name_to_sign }})
                                                        {% elif msrsample.mz_min and msrsample.mz_max %}
                                                            (<span title="{{ msrsample.mz_min }}">{{ msrsample.mz_min|sigdig:4 }}</span>-<span title="{{ msrsample.mz_max }}">{{ msrsample.mz_max|sigdig:4 }}</span>)
                                                        {% endif %}
                                                    </a>{% if not forloop.last %}<br>{% endif %}{% endfor %}{% if not forloop.last %};<br>{% endif %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                            {% endwith %}
                        {% elif sample.sequence_count == 1 %}
                            <td>{{ sample.first_ms_operator }}</td>
                            <td>{{ sample.first_ms_date }}</td>
                            <td>
                                {% for msrun_sample in sample.msrun_samples.all %}
                                    <a href="{% url 'msrunsample_detail' msrun_sample.id %}">MSRunSample Detail
                                        {% if msrun_sample.polarity and msrun_sample.mz_min and msrun_sample.mz_max %}
                                            ({{ msrun_sample.polarity|polarity_name_to_sign }} <span title="{{ msrun_sample.mz_min }}">{{ msrun_sample.mz_min|sigdig:4 }}</span>-<span title="{{ msrun_sample.mz_max }}">{{ msrun_sample.mz_max|sigdig:4 }}</span>)
                                        {% elif msrun_sample.polarity %}
                                            ({{ msrun_sample.polarity|polarity_name_to_sign }})
                                        {% elif msrun_sample.mz_min and msrun_sample.mz_max %}
                                            (<span title="{{ msrun_sample.mz_min }}">{{ msrun_sample.mz_min|sigdig:4 }}</span>-<span title="{{ msrun_sample.mz_max }}">{{ msrun_sample.mz_max|sigdig:4 }}</span>)
                                        {% endif %}
                                    </a>
                                {% endfor %}
                            </td>
                        {% else %}
                            <td><span title="No MSRun associated with the sample" class="text-muted">None</span></td>
                            <td><span title="No MSRun associated with the sample" class="text-muted">None</span></td>
                            <td><span title="No MSRun associated with the sample" class="text-muted">None</span></td>
                        {% endif %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
