{% extends "base.html" %}
{% load customtags %}
{% load static %}

{% block head_extras %}
    {{ block.super }}

    <link href="{% static 'css/hierarchical_formsets.css' %}" rel="stylesheet">
    <link href="{% static 'css/drop_area.css' %}" rel="stylesheet">
    <script src="{% static 'js/file_list_drop_area.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function(){
            peak_annot_input = document.getElementById('peak_annotation_files_field')
            peak_annot_list = document.getElementById('pending_peak_annot_files')

            peak_annot_input.addEventListener(
                'change',
                function() { showPeakAnnotFiles(peak_annot_input.files); },
                false
            );

            function showPeakAnnotFiles (files) {
                peak_annot_list.innerHTML = getFileNamesString(files);
            }
        })
    </script>
{% endblock %}

{% block content %}
    <div>
        <h3>Build a TraceBase Submission</h3>
        <span class="small text-muted">Upload multiple accucor and/or isocorr files and get back an animal and sample table with some data automatically filled in.</span><br><br>
        <form action="{% url 'validate' %}" id="submission-validation" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="peak_annotation_files" class="form-label">Peak Annotation Excel Files:</label>{{ form.peak_annotation_files }}<span class="text-danger">{{ form.peak_annotation_files.errors }}</span>
            <pre id="pending_peak_annot_files" class="drop-area-list-indent"></pre>
            <label for="animal_sample_table" class="form-label">Output Animal and Sample Excel File:<br>
            <span class="small text-muted">(if you have an existing Animal and Sample file you want to update)</span></label>{{ form.animal_sample_table }}<span class="text-danger">{{ form.animal_sample_table.errors }}</span>{% if not form.animal_sample_table.errors %}<br>{% endif %}
            <span class="text-danger">{{ form.non_field_errors }}</span>
            <button type="submit" class="btn btn-primary" id="validate">Validate</button>
            {{ form.management_form }}
        </form>
    </div>

    {% if results %}
        {% if not valid %}
            <br>
            <h5 class="text-danger">The following issue(s) with the file(s) were found:</h5>
            <div class="level-indent">
                Please address the issues below in your file and try again.<br>
                <div class="level-indent small">
                    <span class="{{ 'FAILED'|getClass }}">Errors are in red.</span><br>
                    <span class="{{ 'WARNING'|getClass }}">Warnings are in yellow.</span><br>
                    <span class="{{ 'PASSED'|getClass }}">Validated files are in green.</span><br>
                    <!-- There currently is no unchecked files possible, but planned in issue #659, hence this is commented
                        <span class="{{ 'INFO'|getClass }}">Unchecked files are in blue.</span><br>
                    -->
                </div>
                If it is not clear what the issue is, you may proceed to the <a href="{{ submission_url }}">submission form</a> and a curator will attempt to resolve the issue for you.
            </div>
            <hr>
        {% else %}
            <br>
            <br>
            <h5 class="text-success">Success!  No issues found.  Please proceed to the <a href="{{ submission_url }}">submission form</a>.</h5>
        {% endif %}
        <ul class="ul-nopadding">
            {% for key in ordered_keys %}
                {% with status=results|index:key status_class=results|index:key|getClass err_status="ERROR" wrn_status="WARNING" %}
                    <li class="{{ status_class }}">
                        <u><b>{{ status }}: {{ key }}</b></u>
                        {% if exceptions|index:key %}
                            <ul class="ul-nopadding">
                                {% for exception in exceptions|index:key %}
                                    <li class="{% if exception|index:'is_error' %}{{ err_status|getClass }}{% else %}{{ wrn_status|getClass }}{% endif %}"><b>{{ exception|index:"type" }}</b><br><div class="level-indent"><span class="newlines">{{ exception|index:"message" }}</span></div></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </li>
                {% endwith %}
            {% endfor %}
        </ul>
    {% endif %}

{% endblock %}
