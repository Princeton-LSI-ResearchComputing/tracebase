{% extends "base.html" %}
{% load customtags %}

{% block title %}Archive Files{% endblock %}

{% block content %}
<h4>List of Archive Files</h4>
<br>
<div>
    {% if archive_file_list %}
    <script>
        // setCookie('archive-file-total', '{{ archive_file_list.count }}')
        // setCookie('archive-file-limit', '{{ paginator.per_page }}')
        // setCookie('archive-file-offset', '{{ archive_file_list.count }}')
        function updatePage(params) {
            console.log('Sending', params);
            go = "{{ page_obj.per_page }}" === params.limit
            url = "{% url 'archive_file_list' %}?limit=" + params.limit
            if (typeof params.offset !== "undefined" && params.offset) {
                url += "&offset=" + params.offset;
                go = true;
            }
            if (typeof params.search !== "undefined" && params.search) {
                url += "&search=" + params.search;
                go = true;
            }
            if (typeof params.order !== "undefined" && params.order) {
                url += "&order=" + params.order;
                go = true;
            }
            if (typeof params.sort !== "undefined" && params.sort) {
                url += "&sort=" + params.sort;
                go = true;
            }
            if (go) {
                console.log("Would go to:", url)
                // window.location.href = url;
            }
            {% comment %} return {
                limit: params.limit,
                offset: params.offset,
                search: params.search,
                order: params.order,
                sort: params.sort,
            }; {% endcomment %}
        }

        function onRowsPerPageSelect(numRows) {
            // TODO: Call a method to compile the values and send
            console.log("ROWS PER PAGE EVENT", numRows);
        }

        document.addEventListener("DOMContentLoaded", function(){
            $('#file_list').bootstrapTable({
                onSort: function (order_by, order_dir) {
                    // Note, I will have to trigger the BST sort to show it's sorted
                    // TODO: Save params in a cookie
                    console.log("SORT EVENT:", order_by, order_dir);
                },
                onSearch: function (search_term) {
                    // Note, I will have to populate the search on page load
                    // TODO: Save params in a cookie
                    console.log("GLOBAL SEARCH EVENT:", search_term);
                },
                onColumnSearch: function (column_name, search_term) {
                    // Note, I will have to populate the column searches on page load
                    // TODO: Save params in a cookie
                    console.log("COLUMN SEARCH EVENT:", column_name, search_term);
                },
                onExportStarted: function (event) {
                    // Grab all the data. Note that if I refresh the page, I will have to trigger the download using something like: https://jsfiddle.net/wenyi/wc0zLpef/1/
                    // TODO: Since there's no way to save the selected exportType, add an alert that says that, to export all data, you need to change the rows per page to "All"
                    console.log("EXPORT EVENT", event);
                },
            });

            // Add click listeners on the rows-per-page-option select list items.  See DataRepo.widgets.ListViewRowsPerPageSelectWidget.
            let rowsPerPageOptionElems = document.getElementsByName("rows-per-page-option");
            console.log("Creating " + rowsPerPageOptionElems.length + " event listeners for rowsPerPageOptionElems")
            for (let i = 0; i < rowsPerPageOptionElems.length; i++) {
                rowsPerPageOptionElems[i].addEventListener("click", function (event) {
                    onRowsPerPageSelect($(this).data("value"));
                })
            }
        });
    </script>
    <table class="table table-sm table-hover table-bordered table-responsive-xl table-striped"
        id="file_list"
        data-toggle="table"
        data-buttons-class="primary"
        data-buttons-align="left"
        data-export-types="['csv', 'txt', 'excel']"
        data-export-data-type="all"
        data-filter-control="true"
        data-search="true"
        data-search-align="left"
        data-show-search-clear-button="true"
        data-show-multi-sort="true"
        data-show-columns="true"
        data-show-columns-toggle-all="true"
        data-show-fullscreen="true"
        data-show-export="true"
        data-virtual-scroll="true">
        <thead>
            <tr>
                <th data-field="filename" data-filter-control="input" data-sortable="true" data-sorter="htmlSorter">File Name</th>
                {% comment %} <th data-field="filename" data-filter-control="input" data-sortable="false" data-sorter="alphanum" data-valign="top">
                    <div onclick="sortColumn(this)" class="sortable" id="filename">File Name</div>
                </th> {% endcomment %}
                <th data-field="imported_timestamp" data-filter-control="input" data-sortable="true">File Import Timestamp</th>
                <th data-field="data_type_id" data-filter-control="input" data-sortable="true">File Type</th>
                <th data-field="data_format_id" data-filter-control="input" data-sortable="true">File Format</th>
                <th data-field="studies" data-filter-control="input" data-sortable="true">Study</th>
                <th data-field="peak_groups" data-valign="top" data-sortable="false">Peak Group Data</th>
                <th data-field="peak_data" data-valign="top" data-sortable="false">Peak Data</th>
            </tr>
        </thead>
        <tbody>
            {% for archive_file in archive_file_list %}
                <tr>
                    <td><a href="{% url 'archive_file_detail' archive_file.pk %}">{{ archive_file.filename }}</a></td>
                    <td>{{ archive_file.imported_timestamp }}</td>
                    <td>{{ archive_file.data_type.name }}</td>
                    <td>{{ archive_file.data_format.name }}</td>
                    <td>
                        {% with studies=""|make_list %}
                            <!-- This assumes that all the peak groups that link to this peak annotation ArchiveFile record link to the same MSRunSample/Sample/Animal -->
                            {% if archive_file.peak_groups.first %}
                                {% for study in archive_file.peak_groups.first.msrun_sample.sample.animal.studies.all %}
                                    {% append_unique studies study %}
                                {% endfor %}
                            {% endif %}
                            <!-- This assumes that all the peak groups that link to this MS mz ArchiveFile record link to the same Sample/Animal -->
                            {% if archive_file.mz_to_msrunsamples.first %}
                                {% for study in archive_file.mz_to_msrunsamples.first.sample.animal.studies.all %}
                                    {% append_unique studies study %}
                                {% endfor %}
                            {% endif %}
                            <!-- This assumes that all the peak groups that link to this MS raw ArchiveFile record link to the same Sample/Animal -->
                            {% if archive_file.raw_to_msrunsamples.first %}
                                {% for study in archive_file.raw_to_msrunsamples.first.msrun_sample.sample.animal.studies.all %}
                                    {% append_unique studies study %}
                                {% endfor %}
                            {% endif %}
                            {% for study in studies %}
                                <a href="{% url 'study_detail' study.id %}">{{ study.name }}</a>
                            {% endfor %}
                        {% endwith %}
                    </td>
                    <td>
                        {% if archive_file.data_type.code == "ms_peak_annotation" %}
                            <a href="{% url 'search_basic' 'PeakAnnotationFile' 'id' 'iexact' archive_file.id 'peakgroups' %}">Peak Group Data</a>
                        {% elif archive_file.data_format.code == "ms_raw" %}
                            <a href="{% url 'search_basic' 'RAWFile' 'id' 'iexact' archive_file.id 'peakgroups' %}">Peak Group Data</a>
                        {% elif archive_file.data_format.code == "mzxml" %}
                            <a href="{% url 'search_basic' 'MZFile' 'id' 'iexact' archive_file.id 'peakgroups' %}">Peak Group Data</a>
                        {% else %}
                            No peak groups are linked to this file
                        {% endif %}
                    </td>
                    <td>
                        {% if archive_file.data_type.code == "ms_peak_annotation" %}
                            <a href="{% url 'search_basic' 'PeakAnnotationFile' 'id' 'iexact' archive_file.id 'peakdata' %}">Peak Data</a>
                        {% elif archive_file.data_format.code == "ms_raw" %}
                            <a href="{% url 'search_basic' 'RAWFile' 'id' 'iexact' archive_file.id 'peakdata' %}">Peak Data</a>
                        {% elif archive_file.data_format.code == "mzxml" %}
                            <a href="{% url 'search_basic' 'MZFile' 'id' 'iexact' archive_file.id 'peakdata' %}">Peak Data</a>
                        {% else %}
                            No peak data are linked to this file
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>There are no Archive Files.</p>
    {% endif %}
</div>
{% endblock %}
