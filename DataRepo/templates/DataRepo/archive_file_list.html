{% extends "base.html" %}
{% load customtags %}

{% block title %}Archive Files{% endblock %}

{% block content %}
<h4>List of Archive Files</h4>
<br>
<div>
    {% if archive_file_list %}
    <script>
        function updatePage() {
            let limit = getCookie("archive-file-limit");
            let page = getCookie("archive-file-page");
            // let search = getCookie("archive-file-search");
            // let orderBy = getCookie("archive-file-order-by");
            // let orderDir = getCookie("archive-file-order-dir");

            url = "{% url 'archive_file_list' %}?limit=" + limit
            if (typeof page !== "undefined" && page) {
                url += "&page=" + page;
            }
            // if (typeof search !== "undefined" && search) {
            //     url += "&search=" + search;
            // }
            // if (typeof orderDir !== "undefined" && orderDir) {
            //     url += "&orderdir=" + orderDir;
            // }
            // if (typeof orderBy !== "undefined" && orderBy) {
            //     url += "&orderby=" + orderBy;
            // }
            // activeFilters = false;
            // for (i=0; i < globalThis.columnNames.length; i++) {
            //     filterName = globalThis.columnNames[i];
            //     cookieName = 'archive-file-colSearchCol-' + filterName;
            //     filterValue = getCookie(cookieName);
            //     if (typeof filterValue !== "undefined" && filterValue) {
            //         url += "&filter-" + filterName + "=" + filterValue;
            //         activeFilters = true;
            //     }
            // }
            // if (activeFilters) {
            //     url += "&filternames=" + globalThis.columnNames.join(',');
            // }
            console.log("Going to:", url)
            window.location.href = url;
        }

        function onRowsPerPageChange(numRows) {
            let oldLimit = parseInt(getCookie('archive-file-limit'));
            let curPage = parseInt(getCookie('archive-file-page'));
            let curOffset = (curPage - 1) * oldLimit + 1;
            setCookie('archive-file-limit', numRows);
            closestPage = parseInt(curOffset / numRows) + 1;
            // Reset the page
            setCookie("archive-file-page", closestPage);
            console.log("ROWS PER PAGE EVENT", numRows, "CLOSEST NEW PAGE", closestPage, "PREVIOUS OFFSET", curOffset);
            updatePage();
        }

        function onPageChange(page) {
            setCookie('archive-file-page', page)
            console.log("ROWS PER PAGE EVENT", page);
            updatePage();
        }

        function getColumnNames() {
            firstRow = $('#file_list').bootstrapTable('getData')[0];
            columnNames = Object.keys(firstRow);
            return columnNames
        }

        document.addEventListener("DOMContentLoaded", function(){
            // Set cookies for the current page and limit that comes from the context and is sent via url params.  Everything else is saved in cookies.
            setCookie('archive-file-page', "{{ page_obj.number }}");
            setCookie('archive-file-limit', "{{ page_obj.paginator.per_page }}");
            setCookie("archive-file-filternames", JSON.stringify(getColumnNames()));

            $('#file_list').bootstrapTable({
                onSort: function (orderBy, orderDir) {
                    // Note, I will have to trigger the BST sort to show it's sorted
                    setCookie('archive-file-order-by', orderBy);
                    setCookie('archive-file-order-dir', orderDir);
                    console.log("SORT EVENT:", orderBy, orderDir);
                    updatePage();
                },
                onSearch: function (searchTerm) {
                    // Note, I will have to populate the search on page load
                    let oldTerm = getCookie('archive-file-search');
                    let oldTermDefined = typeof oldTerm === "undefined" || !oldTerm;
                    let newTermDefined = typeof searchTerm === "undefined" || !searchTerm;
                    if (oldTermDefined !== newTermDefined || (oldTermDefined && newTermDefined && oldTerm !== searchTerm)) {
                        setCookie('archive-file-search', searchTerm);
                        console.log("GLOBAL SEARCH EVENT:", searchTerm);
                        updatePage();
                    }
                },
                onColumnSearch: function (columnName, searchTerm) {
                    // Note, I will have to populate the column searches on page load
                    let oldTerm = getCookie('archive-file-filter-' + columnName);
                    let oldTermDefined = typeof oldTerm === "undefined" || !oldTerm;
                    let newTermDefined = typeof searchTerm === "undefined" || !searchTerm;
                    if (oldTermDefined !== newTermDefined || (oldTermDefined && newTermDefined && oldTerm !== searchTerm)) {
                        setCookie('archive-file-filter-' + columnName, searchTerm);
                        console.log("COLUMN SEARCH EVENT:", columnName, searchTerm);
                        updatePage();
                    }
                },
                onExportStarted: function (event) {
                    // Grab all the data. Note that if I refresh the page, I will have to trigger the download using something like: https://jsfiddle.net/wenyi/wc0zLpef/1/
                    // TODO: Since there's no way to save the selected exportType, add an alert that says that, to export all data, you need to change the rows per page to "All"
                    console.log("EXPORT EVENT", event, "THIS:", this);
                    updatePage();
                },
            });

            // Add click listeners on the rows-per-page-option select list items.  See DataRepo.widgets.ListViewRowsPerPageSelectWidget.
            let rowsPerPageOptionElems = document.getElementsByName("rows-per-page-option");
            console.log("Creating " + rowsPerPageOptionElems.length + " event listeners for rowsPerPageOptionElems")
            for (let i = 0; i < rowsPerPageOptionElems.length; i++) {
                rowsPerPageOptionElems[i].addEventListener("click", function (event) {
                    onRowsPerPageChange($(this).data("value"));
                })
            }
        });
    </script>
    <table class="table table-sm table-hover table-bordered table-responsive-xl table-striped"
        id="file_list"
        data-toggle="table"
        data-buttons-class="primary"
        data-buttons-align="left"
        data-export-types="['csv', 'txt', 'excel']"
        data-export-data-type="all"
        data-filter-control="true"
        data-search="true"
        data-search-align="left"
        data-show-search-clear-button="true"
        data-show-multi-sort="true"
        data-show-columns="true"
        data-show-columns-toggle-all="true"
        data-show-fullscreen="true"
        data-show-export="true"
        data-virtual-scroll="true">
        <thead>
            <tr>
                <th data-field="filename" data-filter-control="input" data-sortable="true" data-sorter="htmlSorter">File Name</th>
                {% comment %} <th data-field="filename" data-filter-control="input" data-sortable="false" data-sorter="alphanum" data-valign="top">
                    <div onclick="sortColumn(this)" class="sortable" id="filename">File Name</div>
                </th> {% endcomment %}
                <th data-field="imported_timestamp_str" data-filter-control="input" data-sortable="true">File Import Timestamp</th>
                <th data-field="data_type__name" data-filter-control="input" data-sortable="true">File Type</th>
                <th data-field="data_format__name" data-filter-control="input" data-sortable="true">File Format</th>
                <th data-field="studies_str" data-filter-control="input" data-sortable="true">Study</th>
                <th data-field="peak_groups" data-valign="top" data-sortable="false">Peak Group Data</th>
                <th data-field="peak_data" data-valign="top" data-sortable="false">Peak Data</th>
            </tr>
        </thead>
        <tbody>
            {% for archive_file in archive_file_list %}
                <tr>
                    <td><a href="{% url 'archive_file_detail' archive_file.pk %}">{{ archive_file.filename }}</a></td>
                    <td>{{ archive_file.imported_timestamp_str }}</td>
                    <td>{{ archive_file.data_type.name }}</td>
                    <td>{{ archive_file.data_format.name }}</td>
                    <td>
                        {% with studies=""|make_list %}
                            <!-- This assumes that all the peak groups that link to this peak annotation ArchiveFile record link to the same MSRunSample/Sample/Animal -->
                            {% if archive_file.peak_groups.first %}
                                {% for study in archive_file.peak_groups.first.msrun_sample.sample.animal.studies.all %}
                                    {% append_unique studies study %}
                                {% endfor %}
                            {% endif %}
                            <!-- This assumes that all the peak groups that link to this MS mz ArchiveFile record link to the same Sample/Animal -->
                            {% if archive_file.mz_to_msrunsamples.first %}
                                {% for study in archive_file.mz_to_msrunsamples.first.sample.animal.studies.all %}
                                    {% append_unique studies study %}
                                {% endfor %}
                            {% endif %}
                            <!-- This assumes that all the peak groups that link to this MS raw ArchiveFile record link to the same Sample/Animal -->
                            {% if archive_file.raw_to_msrunsamples.first %}
                                {% for study in archive_file.raw_to_msrunsamples.first.msrun_sample.sample.animal.studies.all %}
                                    {% append_unique studies study %}
                                {% endfor %}
                            {% endif %}
                            {% for study in studies %}
                                <a href="{% url 'study_detail' study.id %}">{{ study.name }}</a>
                            {% endfor %}
                        {% endwith %}
                    </td>
                    <td>
                        {% if archive_file.data_type.code == "ms_peak_annotation" %}
                            <a href="{% url 'search_basic' 'PeakAnnotationFile' 'id' 'iexact' archive_file.id 'peakgroups' %}">Peak Group Data</a>
                        {% elif archive_file.data_format.code == "ms_raw" %}
                            <a href="{% url 'search_basic' 'RAWFile' 'id' 'iexact' archive_file.id 'peakgroups' %}">Peak Group Data</a>
                        {% elif archive_file.data_format.code == "mzxml" %}
                            <a href="{% url 'search_basic' 'MZFile' 'id' 'iexact' archive_file.id 'peakgroups' %}">Peak Group Data</a>
                        {% else %}
                            No peak groups are linked to this file
                        {% endif %}
                    </td>
                    <td>
                        {% if archive_file.data_type.code == "ms_peak_annotation" %}
                            <a href="{% url 'search_basic' 'PeakAnnotationFile' 'id' 'iexact' archive_file.id 'peakdata' %}">Peak Data</a>
                        {% elif archive_file.data_format.code == "ms_raw" %}
                            <a href="{% url 'search_basic' 'RAWFile' 'id' 'iexact' archive_file.id 'peakdata' %}">Peak Data</a>
                        {% elif archive_file.data_format.code == "mzxml" %}
                            <a href="{% url 'search_basic' 'MZFile' 'id' 'iexact' archive_file.id 'peakdata' %}">Peak Data</a>
                        {% else %}
                            No peak data are linked to this file
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>There are no Archive Files.</p>
    {% endif %}
</div>
{% endblock %}
