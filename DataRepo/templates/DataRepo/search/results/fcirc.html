{% load customtags %}
{% block content %}
    {# local_debug=False overrides settings.debug sent in as 'debug'.  Effective_debug will only be true if both local and global are true #}
    {% define False as local_debug %}
    {% define False as effective_debug %}
    {% if local_debug %}
        {% define debug as effective_debug %}
    {% endif %}
    <table class="table table-highlighted table-hover table-bordered">
        <tr class="bg-highlighted">
            <th colspan="7" rowspan="2"></th>
            <th colspan="4">Average</th>
            <th colspan="4">Intact</th>
            {% if effective_debug %}
                <th colspan="4" rowspan="2" class="align-bottom">Debug Mode Columns</th>
            {% endif %}
        </tr>
        <tr class="bg-highlighted">
            <th colspan="2">Weight Normalized<small> (nM/m/g)</small></th>
            <th colspan="2">Mouse Normalized<small> (nM/m)</small></th>
            <th colspan="2">Weight Normalized<small> (nM/m/g)</small></th>
            <th colspan="2">Mouse Normalized<small> (nM/m)</small></th>
        </tr>
        <tr class="bg-highlighted">
            <th>Animal</th>
            <th>Study</th>
            <th>Treatment</th>
            <th>Tracer Compound</th>
            <th>Tracer Infusion Rate (ul/min/g)</th>
            <th>Tracer Infusion Concentration (mM)</th>
            <th>Time Collected (mins)</th>
            <th>Ra</th>
            <th>Rd</th>
            <th>Ra</th>
            <th>Rd</th>
            <th>Ra</th>
            <th>Rd</th>
            <th>Ra</th>
            <th>Rd</th>
            {% if effective_debug %}
                <th>PeakGroup</th>
                <th>Tissue</th>
                <th>Sample</th>
                <th>Final Serum Sample</th>
            {% endif %}
        </tr>

        {% for pg in res.all %}
            {% if pg.is_tracer_compound_group %}
                <tr{% if pg.msrun.sample.id == pg.msrun.sample.animal.final_serum_sample_id %} class="bg-highlighted"{% endif %}>
                    <!-- Animal -->
                    <td{% if pg.msrun.sample.id == pg.msrun.sample.animal.final_serum_sample_id %} class="bg-highlighted"{% endif %}>
                        <a href="{% url 'animal_detail' pg.msrun.sample.animal.id %}">
                            {{ pg.msrun.sample.animal.name }}
                        </a>
                    </td>

                    <!-- Studies -->
                    <td>
                        {% for study in pg.msrun.sample.animal.studies.all %}
                            <a href="{% url 'study_detail' study.id %}">
                                {{ study.name }}
                            </a><br>
                        {% endfor %}
                    </td>

                    <!-- Treatment -->
                    <td>
                        {% if pg.msrun.sample.animal.treatment is None %}
                            None
                        {% else %}
                            <a href="{% url 'protocol_detail' pg.msrun.sample.animal.treatment.id %}">
                                {{ pg.msrun.sample.animal.treatment.name }}
                            </a>
                        {% endif %}
                    </td>

                    <!-- Tracer Compound -->
                    <td>
                        <a href="{% url 'compound_detail' pg.msrun.sample.animal.tracer_compound.id %}">
                            {{ pg.msrun.sample.animal.tracer_compound.name }}
                        </a>
                    </td>

                    <!-- Tracer Infusion Rate (ul/min/g) -->
                    <td class="text-end">
                        {{ pg.msrun.sample.animal.tracer_infusion_rate }}
                    </td>

                    <!-- Tracer Infusion Concentration (mM) -->
                    <td class="text-end">
                        {{ pg.msrun.sample.animal.tracer_infusion_concentration }}
                    </td>

                    <!-- Time Collected (mins) -->
                    <td class="text-end">
                        <p title="{{ pg.msrun.sample.time_collected }}">{{ pg.msrun.sample.time_collected|durationToMins|decimalPlaces:2 }}</p>
                    </td>

                    <!-- Average Ra (nmol/min/g) -->
                    <td class="text-end">
                        {% if pg.rate_appearance_average_per_gram is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_appearance_average_per_gram }}">{{ pg.rate_appearance_average_per_gram|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Average Rd (nmol/min/g) -->
                    <td class="text-end">
                        {% if pg.rate_disappearance_average_per_gram is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_disappearance_average_per_gram }}">{{ pg.rate_disappearance_average_per_gram|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Average Ra (nmol/min) -->
                    <td class="text-end">
                        {% if pg.rate_appearance_average_per_animal is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_appearance_average_per_animal }}">{{ pg.rate_appearance_average_per_animal|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Average Rd (nmol/min) -->
                    <td class="text-end">
                        {% if pg.rate_disappearance_average_per_animal is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_disappearance_average_per_animal }}">{{ pg.rate_disappearance_average_per_animal|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Intact Ra (nmol/min/g) -->
                    <td class="text-end">
                        {% if pg.rate_appearance_intact_per_gram is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_appearance_intact_per_gram }}">{{ pg.rate_appearance_intact_per_gram|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Intact Rd (nmol/min/g) -->
                    <td class="text-end">
                        {% if pg.rate_disappearance_intact_per_gram is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_disappearance_intact_per_gram }}">{{ pg.rate_disappearance_intact_per_gram|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Intact Ra (nmol/min) -->
                    <td class="text-end">
                        {% if pg.rate_appearance_intact_per_animal is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_appearance_intact_per_animal }}">{{ pg.rate_appearance_intact_per_animal|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    <!-- Intact Rd (nmol/min) -->
                    <td class="text-end">
                        {% if pg.rate_disappearance_intact_per_animal is None %}
                            None
                        {% else %}
                            <p title="{{ pg.rate_disappearance_intact_per_animal }}">{{ pg.rate_disappearance_intact_per_animal|floatformat:2 }}</p>
                        {% endif %}
                    </td>

                    {% if effective_debug %}
                        <td>
                            {{ pg.name }} (Tracer cmpd ID {{ pg.msrun.sample.animal.tracer_compound.id }}) in? PeakGroup cmpds: [
                            {% for cmpd in pg.compounds.all %}
                                {{ cmpd.id }}
                                {% if pg.msrun.sample.animal.tracer_compound.id == cmpd.id %}
                                    *
                                {% endif %}
                            {% endfor %} ]
                        </td>
                        <td>
                            {{ pg.msrun.sample.tissue.name }}
                        </td>
                        <td>
                            <a href="{% url 'sample_detail' pg.msrun.sample.id %}">
                                {{ pg.msrun.sample.id }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'sample_detail' pg.msrun.sample.animal.final_serum_sample_id %}">
                                {{ pg.msrun.sample.animal.final_serum_sample_id }}
                            </a>
                        </td>
                    {% endif %}
                </tr>
            {% endif %}
        {% endfor %}
    </table>
    <br>
    <table class="table table-highlighted-legend table-hover table-bordered">
        <tr class="bg-highlighted">
            <th>Color Legend</th>
        </tr>
        <tr>
            <td>Previous (or no) serum sample</td>
        </tr>
        <tr class="bg-highlighted">
            <td>Last serum sample</td>
        </tr>
    </table>
{% endblock %}
