{% load customtags %}
{% load static %}
{% block head_extras %}
    <script src="https://cdn.jsdelivr.net/gh/wenzhixin/bootstrap-table-examples@master/utils/natural-sorting/dist/natural-sorting.js"></script>
    <script>
        // Inspired by: https://stackoverflow.com/questions/12455699/show-hide-table-column-with-colspan-using-jquery

        document.addEventListener("DOMContentLoaded", function(){
            // https://bootstrap-table.com/docs/api/events/
            // https://bootstrap-table.com/docs/api/events/#oncolumnswitch
            $("#advsrchres").bootstrapTable({
                onAll: function() {
                    updateColumnSwitching()
                    {% if mode != 'view' %}
                        updateColumnSortControls()
                    {% endif %}
                    updateAllColumnSwitchingCookies()
                }
                // I did have an onColumnSwitch here to set cookies, but it doesn't handle the "Toggle All" control, so I added a call to updateAllColumnSwitchingCookies in onAll
            })

            $("#showaverage").on("click", function(e) {
                var acbv = $(this).is(":checked")
                var icbv = $("#showintact").is(":checked")

                if (!acbv && !icbv) {
                    e.preventDefault()
                    alert("Too few display columns. At least 1 of Average or Intact must be selected.")
                    return
                }

                updateColumnSwitching()
            })

            $("#showintact").on("click", function(e) {
                var icbv = $(this).is(":checked")
                var acbv = $("#showaverage").is(":checked")

                if (!acbv && !icbv) {
                    e.preventDefault()
                    alert("Too few display columns. At least 1 of Average or Intact must be selected.")
                    return
                }

                updateColumnSwitching()
            })

            $("#showweight").on("click", function(e) {
                var wcbv = $(this).is(":checked")
                var ncbv = $("#shownonorm").is(":checked")

                if (!ncbv && !wcbv) {
                    e.preventDefault()
                    alert("Too few display columns. At least 1 of Weight-normalized or mouse-normalized must be selected.")
                    return
                }

                updateColumnSwitching()
            })

            $("#shownonorm").on("click", function(e) {
                var ncbv = $(this).is(":checked")
                var wcbv = $("#showweight").is(":checked")

                if (!ncbv && !wcbv) {
                    e.preventDefault()
                    alert("Too few display columns. At least 1 of Weight-normalized or mouse-normalized must be selected.")
                    return
                }

                updateColumnSwitching()
            })

            $("#showra").on("click", function(e) {
                var racbv = $(this).is(":checked")
                var rdcbv = $("#showrd").is(":checked")

                if (!racbv && !rdcbv) {
                    e.preventDefault()
                    alert("Too few display columns. At least 1 of Ra or Rd must be selected.")
                    return
                }

                updateColumnSwitching()
            })

            $("#showrd").on("click", function(e) {
                var rdcbv = $(this).is(":checked")
                var racbv = $("#showra").is(":checked")

                if (!racbv && !rdcbv) {
                    e.preventDefault()
                    alert("Too few display columns. At least 1 of Ra or Rd must be selected.")
                    return
                }

                updateColumnSwitching()
            })

            $("#showlast").on("click", function(e) {
                var lcbv = $(this).is(":checked")
                var nlcbv = $("#shownotlast").is(":checked")

                if (!nlcbv && !lcbv) {
                    e.preventDefault()
                    alert("Too few display rows. At least 1 of Previous or Last serum samples must be selected.")
                    return
                }

                updateSearch()
            })

            $("#shownotlast").on("click", function(e) {
                var nlcbv = $(this).is(":checked")
                var lcbv = $("#showlast").is(":checked")

                if (!nlcbv && !lcbv) {
                    e.preventDefault()
                    alert("Too few display rows. At least 1 of Previous or Last serum samples must be selected.")
                    return
                }

                updateSearch()
            })
        })

        /**
         * Creates (or modifies a previously created) new "and"-group to the search hierarchy at the root level,
         * containing a query for the is_last field (based on the checkbox states) and the original group.  It also
         * removes incomplete search forms and submits the search.  For example, if the search is:
         *    Match `any`:
         *        `animal` `is` `971`
         *        `time_collected` `>` `00:00:01`
         * ...and "last" is unchecked and "previous" is checked, the resulting search will be:
         *    Match `all`:
         *        `is_last` `is` `false`
         *        Match `any`:
         *            `animal` `is` `971`
         *            `time_collected` `>` `00:00:01`
         */
        function updateSearch() {
            var snl = $("#shownotlast").is(":checked")
            var sl = $("#showlast").is(":checked")

            let group = {
                type: 'group',
                pos: '',
                static: false,
                val: 'all',
            }
            let query = {
                type: 'query',
                pos: '',
                static: false,
                ncmp: 'iexact',
                fld: 'is_last',
                val: 'true',  // Cannot be boolean because of the way defined checks are done in javascript
            }

            if(snl && sl) {
                query.ncmp = 'not_isnull'
                query.val = 'dummy'
            } else if (!snl && sl) {
                query.ncmp = 'iexact'
                query.val = 'true'  // Cannot be boolean because of the way defined checks are done in javascript
            } else if (snl && !sl) {
                query.ncmp = 'iexact'
                query.val = 'false'  // Cannot be boolean because of the way defined checks are done in javascript
            } else {
                query.ncmp = 'isnull'
                query.val = 'dummy'
            }

            let last_form_pos = getFirstFieldFormNum('is_last')
            let reroot_mode = true
            if (last_form_pos === 1) {
                let rootSize = getRootGroupSize()
                // If the root search hoerarchy level has 2 members and 1 is a form (that we assume is 'is_last')
                // Note, this could be a false assumption if the first member is a group whose first form is for is_last
                if (rootSize.members === 2 && rootSize.forms === 1) {
                    reroot_mode = false
                }
            }

            // Remove any search terms for the is_last field
            removeFieldSearchForms('is_last')
            // Remove incomplete search forms
            removeIncompleteSearchForms()

            if (reroot_mode) {
                // Insert a new 'and'-group with a single query at the root and append the existing search group (formerly the root) as a sibling of that query, if any
                reRootSearch(group, query, 'fctemplate')
            } else {
                // This essentially does the same thing as above.  It just doesn't create or move-around the group select lists when there exists filled-out user search criteria
                insertFirstSearch(query, 'fctemplate')
            }

            // Commit (/save) the form, i.e. prepare for submission
            var myform = document.getElementById("hierarchical-search-form")
            saveSearchQueryHierarchy(document.querySelector('.hierarchical-search'))
            // Submit the form
            myform.submit();
        }

        function updateColumnSwitching() {
            var ncbv = $("#shownonorm").is(":checked")
            var wcbv = $("#showweight").is(":checked")
            var acbv = $("#showaverage").is(":checked")
            var icbv = $("#showintact").is(":checked")
            var racbv = $("#showra").is(":checked")
            var rdcbv = $("#showrd").is(":checked")

            // Everything is either average or intact
            $("#advsrchres .average, .intact").each(function() {
                if(
                    ( // One of each of 3 class in each pair is present (average/intact, weight/nonorm, & ra/rd)
                        ((acbv && $(this).hasClass("average"))
                            || (icbv && $(this).hasClass("intact")))
                        && ((ncbv && $(this).hasClass("nonorm"))
                            || (wcbv && $(this).hasClass("weight")))
                        && ((racbv && $(this).hasClass("ra"))
                            || rdcbv && $(this).hasClass("rd"))
                    )
                    || ( // All but ra/rd class present
                        (($(this).hasClass("average") || $(this).hasClass("intact"))
                            && ($(this).hasClass("nonorm") || $(this).hasClass("weight"))
                            && !$(this).hasClass("ra") && !$(this).hasClass("rd"))
                        && (
                            ((acbv && $(this).hasClass("average"))
                                || (icbv && $(this).hasClass("intact")))
                            && ((ncbv && $(this).hasClass("nonorm"))
                                || (wcbv && $(this).hasClass("weight")))
                        )
                    )
                    || ( // Only Average/intact class present
                        (($(this).hasClass("average") || $(this).hasClass("intact"))
                            && !$(this).hasClass("nonorm") && !$(this).hasClass("weight")
                            && !$(this).hasClass("ra") && !$(this).hasClass("rd"))
                        && (
                            (acbv && $(this).hasClass("average"))
                            || (icbv && $(this).hasClass("intact"))
                        )
                    )
                )
                    {$(this).show()}
                else
                    {$(this).hide()}
            })

            adjustAverageIntact(acbv, icbv, wcbv, ncbv, racbv, rdcbv)
        }

        function adjustAverageIntact(acbv, icbv, wcbv, ncbv, racbv, rdcbv) {
            var parentincrement = 0;
            if ( racbv )
                {parentincrement += 1}
            if ( rdcbv )
                {parentincrement += 1}
            var parentsize = 0
            if ( wcbv )
                {parentsize += parentincrement}
            if ( ncbv )
                {parentsize += parentincrement}
            // For each parent
            $("#advsrchres .average").not(".weight, .nonorm").each(function() {
                if ( !acbv || parentsize == 0 ) {
                    $(this).hide()
                } else {
                    $(this).show()
                    $(this).attr("colspan", parentsize)
                }
            })
            $("#advsrchres .intact").not(".weight, .nonorm").each(function() {
                if ( !icbv || parentsize == 0 ) {
                    $(this).hide()
                } else {
                    $(this).show()
                    $(this).attr("colspan", parentsize)
                }
            })
            $("#advsrchres .weight").not(".ra, .rd").each(function() {
                if ( !wcbv || parentincrement == 0
                    || (!icbv && $(this).hasClass("intact"))
                    || (!acbv && $(this).hasClass("average"))
                ) {
                    $(this).hide()
                } else {
                    $(this).show()
                    $(this).attr("colspan", parentincrement)
                }
            })
            $("#advsrchres .nonorm").not(".ra, .rd").each(function() {
                if ( !ncbv || parentincrement == 0
                    || (!icbv && $(this).hasClass("intact"))
                    || (!acbv && $(this).hasClass("average"))
                ) {
                    $(this).hide()
                } else {
                    $(this).show()
                    $(this).attr("colspan", parentincrement)
                }
            })
        }
    </script>
{% endblock %}
{% block content %}
    <div style="float: right; {% if mode == 'view' %}margin-right: 1rem;margin-bottom: 1rem;{% else %}margin-right: 1rem;{% endif %}" class="buttons-toolbar"></div>
    <div style="float: right; margin-right: 1rem;">
        <small>
            <table class="table table-highlighted-legend table-hover table-bordered">
                <tr>
                    <td><strong>Calculation Method</strong></td>
                    <td>
                        {% get_template_cookie selfmt 'showaverage' 'checked' as avgchkd %}
                        {% if avgchkd == "checked" %}
                            <input type="checkbox" id="{% uniquify 'showaverage' 1 %}" onclick="set_template_cookie('showaverage', this.checked ? 'checked' : '')" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'showaverage' 2 %}" onclick="set_template_cookie('showaverage', this.checked ? 'checked' : '')" />
                        {% endif %}
                        Average
                    </td>
                    <td>
                        {% get_template_cookie selfmt 'showintact' 'checked' as ntctchkd %}
                        {% if ntctchkd == "checked" %}
                            <input type="checkbox" id="{% uniquify 'showintact' 1 %}" onclick="set_template_cookie('showintact', this.checked ? 'checked' : '')" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'showintact' 2 %}" onclick="set_template_cookie('showintact', this.checked ? 'checked' : '')" />
                        {% endif %}
                        Intact
                    </td>
                </tr>
                <tr>
                    <td><strong>Normalization Method</strong></td>
                    <td>
                        {% get_template_cookie selfmt 'showweight' 'checked' as wghtchkd %}
                        {% if wghtchkd == "checked" %}
                            <input type="checkbox" id="{% uniquify 'showweight' 1 %}" onclick="set_template_cookie('showweight', this.checked ? 'checked' : '')" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'showweight' 2 %}" onclick="set_template_cookie('showweight', this.checked ? 'checked' : '')" />
                        {% endif %}
                        Per gram body-weight
                    </td>
                    <td>
                        {% get_template_cookie selfmt 'shownonorm' 'checked' as nnrmchkd %}
                        {% if nnrmchkd == "checked" %}
                            <input type="checkbox" id="{% uniquify 'shownonorm' 1 %}" onclick="set_template_cookie('shownonorm', this.checked ? 'checked' : '')" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'shownonorm' 2 %}" onclick="set_template_cookie('shownonorm', this.checked ? 'checked' : '')" />
                        {% endif %}
                        Per animal
                    </td>
                </tr>
                <tr>
                    <td><strong>Calculation Type</strong></td>
                    <td>
                        {% get_template_cookie selfmt 'showrd' 'checked' as rdchkd %}
                        {% if rdchkd == "checked" %}
                            <input type="checkbox" id="{% uniquify 'showrd' 1 %}" onclick="set_template_cookie('showrd', this.checked ? 'checked' : '')" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'showrd' 2 %}" onclick="set_template_cookie('showrd', this.checked ? 'checked' : '')" />
                        {% endif %}
                        Rd (disappearance rate)
                    </td>
                    <td>
                        {% get_template_cookie selfmt 'showra' 'checked' as rachkd %}
                        {% if rachkd == "checked" %}
                            <input type="checkbox" id="{% uniquify 'showra' 1 %}" onclick="set_template_cookie('showra', this.checked ? 'checked' : '')" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'showra' 2 %}" onclick="set_template_cookie('showra', this.checked ? 'checked' : '')" />
                        {% endif %}
                        Ra (appearance rate)
                    </td>
                </tr>
                <tr>
                    <td>
                        <strong>Serum Tracer Peak Groups (rows)</strong>
                        {% get_serum_tracer_peak_groups_first_searched qry as stpg_searched %}
                    </td>
                    <td>
                        {% if stpg_searched == "both" or stpg_searched == "previous" %}
                            <input type="checkbox" id="{% uniquify 'shownotlast' 1 %}" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'shownotlast' 2 %}" />
                        {% endif %}
                        Previous
                    </td>
                    <td class="bg-highlighted">
                        {% if stpg_searched == "both" or stpg_searched == "last" %}
                            <input type="checkbox" id="{% uniquify 'showlast' 1 %}" checked />
                        {% else %}
                            <input type="checkbox" id="{% uniquify 'showlast' 2 %}" />
                        {% endif %}
                        Last
                    </td>
                </tr>
            </table>
        </small>
    </div>
    <table class="table table-highlighted table-hover table-bordered"
        id="advsrchres"
        data-toggle="table"
        data-buttons-toolbar=".buttons-toolbar"
        data-buttons-class="primary"
        data-buttons-align="right"
        data-filter-control="false"
        data-search="false"
        data-show-search-clear-button="false"
        data-show-multi-sort="{% if mode == 'view' %}true{% else %}false{% endif %}"
        data-show-columns="true"
        data-show-columns-toggle-all="true"
        data-show-fullscreen="false"
        data-show-export="false"
        data-pagination="{% if mode == 'view' %}true{% else %}false{% endif %}">
        <thead>
            <tr>
                <th colspan="16" rowspan="2"></th>
                <th colspan="4" class="average">Average</th>
                <th colspan="4" class="intact">Intact</th>
            </tr>
            <tr>
                <th colspan="2" data-sortable="false" class="average weight">Weight<br>Normalized<br>(nmol/min/g)</th>
                <th colspan="2" data-sortable="false" class="average nonorm">Mouse<br>Normalized<br>(nmol/min)</th>
                <th colspan="2" data-sortable="false" class="intact weight">Weight<br>Normalized<br>(nmol/min/g)</th>
                <th colspan="2" data-sortable="false" class="intact nonorm">Mouse<br>Normalized<br>(nmol/min)</th>
            </tr>
            <tr>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Status-data-visible' 'true' %}" data-field="Status">
                    <p title="FCirc Calculation Status - Note: This status is not included in the data download."><img src="{% static 'images/status-question.png' %}" alt="Status" width="20"></p>
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Studies-data-visible' 'true' %}" data-field="Studies">
                    {% with "Studies" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__studies__name">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Animal-data-visible' 'true' %}" data-field="Animal">
                    {% with "Animal" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__name">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'SerumSample-data-visible' 'true' %}" data-field="Serum_Sample">
                    {% with "Serum<br>Sample" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__name">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Genotype-data-visible' 'true' %}" data-field="Genotype">
                    {% with "Genotype" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__genotype">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="{% get_template_cookie selfmt 'Body_Weight-data-visible' 'false' %}" data-field="Body_Weight">
                    {% with "Body<br>Weight<br>(g)" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__body_weight">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Age-data-visible' 'false' %}" data-field="Age">
                    {% with "Age<br>(weeks)" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__age">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Sex-data-visible' 'false' %}" data-field="Sex">
                    {% with "Sex" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__sex">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Diet-data-visible' 'false' %}" data-field="Diet">
                    {% with "Diet" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__diet">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Feeding_Status-data-visible' 'true' %}" data-field="Feeding_Status">
                    {% with "Feeding<br>Status" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__feeding_status">Feeding<br>Status</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Treatment-data-visible' 'true' %}" data-field="Treatment">
                    {% with "Treatment" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__treatment__name">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Tracer-data-visible' 'true' %}" data-field="Tracer">
                    {% with "Tracer" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="tracer__name">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Labeled_Element-data-visible' 'true' %}" data-field="Labeled_Element">
                    {% with "Labeled<br>Element" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="element">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="{% get_template_cookie selfmt 'Infusion_Rate-data-visible' 'true' %}" data-field="Infusion_Rate">
                    {% with "Infusion<br>Rate<br>(ul/m/g)" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__infusion_rate">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="{% get_template_cookie selfmt 'Tracer_Concentration-data-visible' 'true' %}" data-field="Tracer_Concentration">
                    {% with "Tracer<br>Concentration<br>(mM)" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__animal__infusate__tracer_links__concentration">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="alphanum" data-visible="{% get_template_cookie selfmt 'Time_Collected-data-visible' 'true' %}" data-field="Time_Collected">
                    {% with "Time<br>Collected<br>(m)" as colhead %}
                        {% if mode == "view" %}{{ colhead }}{% else %}
                            <div onclick="sortColumn(this)" class="sortable" id="serum_sample__time_collected">{{ colhead }}</div>
                        {% endif %}
                    {% endwith %}
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Average_Weight_Normalized_Ra" data-title-tooltip="Average_Weight_Normalized_Ra" class="average weight ra">
                    Ra
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Average_Weight_Normalized_Rd" data-title-tooltip="Average_Weight_Normalized_Rd" class="average weight rd">
                    Rd
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Average_Mouse_Normalized_Ra" data-title-tooltip="Average_Mouse_Normalized_Ra" class="average nonorm ra">
                    Ra
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Average_Mouse_Normalized_Rd" data-title-tooltip="Average_Mouse_Normalized_Rd" class="average nonorm rd">
                    Rd
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Intact_Weight_Normalized_Ra" data-title-tooltip="Intact_Weight_Normalized_Ra" class="intact weight ra">
                    Ra
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Intact_Weight_Normalized_Rd" data-title-tooltip="Intact_Weight_Normalized_Rd" class="intact weight rd">
                    Rd
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Intact_Mouse_Normalized_Ra" data-title-tooltip="Intact_Mouse_Normalized_Ra" class="intact nonorm ra">
                    Ra
                </th>
                <th data-valign="top" data-sortable="{% if mode == 'view' %}true{% else %}false{% endif %}" data-sorter="numericOnly" data-visible="true" data-switchable="false" data-field="Intact_Mouse_Normalized_Rd" data-title-tooltip="Intact_Mouse_Normalized_Rd" class="intact nonorm rd">
                    Rd
                </th>
            </tr>
        </thead>

        <tbody>
            {% for rec in res.all %}
                <tr class="{% if rec.is_last_serum_peak_group %}bg-highlighted{% else %}bg-normal{% endif %}">
                    <!-- Status -->
                    <td class="center-all">
                        {% if rec.serum_validity.valid %}
                            <p title="{{ rec.serum_validity.message }}"><img src="{% static 'images/status-good.png' %}" alt="good" width="20"></p>
                        {% else %}
                            {% if rec.serum_validity.level == "warn" %}
                                <p title="{{ rec.serum_validity.message }}"><img src="{% static 'images/status-warn.png' %}" alt="warning" width="20"></p>
                            {% else %}
                                <p title="{{ rec.serum_validity.message }}"><img src="{% static 'images/status-error.png' %}" alt="error" width="20">
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- Studies -->
                    <td>
                        <!-- This will work as intended even if rec.serum_sample.animal.study wasn't added as an annotation (e.g. if split_rows is false or root_annot_fld is not defined) -->
                        {% get_many_related_rec rec.serum_sample.animal.studies rec.study as studies %}
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">
                            {% for study in studies %}{% if not forloop.first %},<br>{% endif%}{{ study.name }}{% empty %}None{% endfor %}
                        </div>

                        {% for study in studies %}{% if not forloop.first %},<br>{% endif%}<a href="{% url 'study_detail' study.id %}">{{ study.name }}</a>{% empty %}None{% endfor %}
                    </td>

                    <!-- Animal -->
                    <td>
                        {% if rec.serum_sample.animal is None %}
                            None
                        {% else %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">{{ rec.serum_sample.animal.name }}</div>
                            <a href="{% url 'animal_detail' rec.serum_sample.animal.id %}">
                                {{ rec.serum_sample.animal.name|default_if_none:"None" }}
                            </a>
                        {% endif %}
                    </td>

                    <!-- Serum Sample -->
                    <td>
                        {% if rec.serum_sample is None %}
                            None
                        {% else %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">{{ rec.serum_sample.name }}</div>
                            <a href="{% url 'sample_detail' rec.serum_sample.id %}">
                                {{ rec.serum_sample.name|default_if_none:"None" }}
                            </a>
                        {% endif %}
                    </td>

                    <!-- Genotype -->
                    <td>
                        {{ rec.serum_sample.animal.genotype|default_if_none:"None" }}
                    </td>

                    <!-- Body Weight (g) -->
                    <td class="text-end">
                        {{ rec.serum_sample.animal.body_weight|default_if_none:"None" }}
                    </td>

                    <!-- Age (weeks) -->
                    <td class="text-end">
                        <p title="{{ rec.serum_sample.animal.age }} (d-hh:mm:ss)">{{ rec.serum_sample.animal.age|durationToWeeks|decimalPlaces:2|default_if_none:"None" }}</p>
                    </td>

                    <!-- Sex -->
                    <td>
                        {{ rec.serum_sample.animal.sex|default_if_none:"None" }}
                    </td>

                    <!-- Diet -->
                    <td>
                        {{ rec.serum_sample.animal.diet|default_if_none:"None" }}
                    </td>

                    <!-- Feeding Status -->
                    <td>
                        {{ rec.serum_sample.animal.feeding_status|default_if_none:"None" }}
                    </td>

                    <!-- Treatment -->
                    <td>
                        {% if rec.serum_sample.animal.treatment is None %}
                            None
                        {% else %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">{{ rec.serum_sample.animal.treatment.name|default_if_none:"None" }}</div>

                            <a href="{% url 'protocol_detail' rec.serum_sample.animal.treatment.id %}">
                                {{ rec.serum_sample.animal.treatment.name|default_if_none:"None" }}
                            </a>
                        {% endif %}
                    </td>

                    <!-- Tracer -->
                    <td>
                        {% if rec.tracer is None %}
                            None
                        {% else %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">{{ rec.tracer.name|default_if_none:"None" }}</div>
                            <a href="{% url 'compound_detail' rec.tracer.compound.id %}">
                                <div class="nobr">{{ rec.tracer.name|default_if_none:"None" }}</div>
                            </a>
                        {% endif %}
                    </td>

                    <!-- Labeled Element -->
                    <td>
                        {{ rec.element|default_if_none:"None" }}
                    </td>

                    <!-- Infusion Rate (ul/m/g) -->
                    <td class="text-end">
                        {{ rec.serum_sample.animal.infusion_rate|default_if_none:"None" }}
                    </td>

                    <!-- Tracer Concentration (mM) -->
                    <td class="text-end">
                        <!-- This will get all tracer_link records for every tracer in the infusate, so we need to filter those for the tracer in this FCirc record -->
                        <!-- This is not effectively a many to many relationship because of the override of getRootQuerySet in fluxcirc_dataformat.py, which forces the FCirc.tracer to match FCirc.serum_sample.animal.tracer_links.tracer -->
                        {% if rec.serum_sample.animal.infusate is None %}
                            None
                        {% else %}
                            {% get_many_related_rec rec.serum_sample.animal.tracer_links.all rec.tracer_link as tracer_links %}
                            {% for tracer_link in tracer_links %}{% if not forloop.first %},<br>{% endif%}{{ tracer_link.concentration }}{% empty %}None{% endfor %}
                        {% endif %}
                    </td>

                    <!-- Time Collected (m) -->
                    <td class="text-end">
                        <p title="{{ rec.serum_sample.time_collected }} (h:m:s)">{{ rec.serum_sample.time_collected|durationToMins|decimalPlaces:2|default_if_none:"None" }}</p>
                    </td>

                    <!-- Average Ra (nmol/min/g) -->
                    <td class="text-end average weight ra">
                        <p title="{{ rec.rate_appearance_average_per_gram|floatformat:10 }}">{{ rec.rate_appearance_average_per_gram|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Average Rd (nmol/min/g) -->
                    <td class="text-end average weight rd">
                        <p title="{{ rec.rate_disappearance_average_per_gram|floatformat:10 }}">{{ rec.rate_disappearance_average_per_gram|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Average Ra (nmol/min) -->
                    <td class="text-end average nonorm ra">
                        <p title="{{ rec.rate_appearance_average_per_animal|floatformat:10 }}">{{ rec.rate_appearance_average_per_animal|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Average Rd (nmol/min) -->
                    <td class="text-end average nonorm rd">
                        <p title="{{ rec.rate_disappearance_average_per_animal|floatformat:10 }}">{{ rec.rate_disappearance_average_per_animal|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Intact Ra (nmol/min/g) -->
                    <td class="text-end intact weight ra">
                        <p title="{{ rec.rate_appearance_intact_per_gram|floatformat:10 }}">{{ rec.rate_appearance_intact_per_gram|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Intact Rd (nmol/min/g) -->
                    <td class="text-end intact weight rd">
                        <p title="{{ rec.rate_disappearance_intact_per_gram|floatformat:10 }}">{{ rec.rate_disappearance_intact_per_gram|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Intact Ra (nmol/min) -->
                    <td class="text-end intact nonorm ra">
                        <p title="{{ rec.rate_appearance_intact_per_animal|floatformat:10 }}">{{ rec.rate_appearance_intact_per_animal|floatformat:2|default:"None" }}</p>
                    </td>

                    <!-- Intact Rd (nmol/min) -->
                    <td class="text-end intact nonorm rd">
                        <p title="{{ rec.rate_disappearance_intact_per_animal|floatformat:10 }}">{{ rec.rate_disappearance_intact_per_animal|floatformat:2|default:"None" }}</p>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
