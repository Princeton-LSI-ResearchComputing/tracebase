{% load customtags %}
{% block head_extras %}

    <script>
        // Correct the row count to account for M:M related tables
        document.addEventListener("DOMContentLoaded", function(){
            // https://bootstrap-table.com/docs/api/events/
            // https://bootstrap-table.com/docs/api/events/#oncolumnswitch
            $("#advsrchres").bootstrapTable({
                onAll: function() {
                    updateColumnGroups()
                },
                onColumnSwitch: function(field, checked) {
                    set_template_cookie(field + '-data-visible', checked)
                    // This is to update the server-side sort controls after a column switch
                    setupColumnSort()
                }
            })

            function updateColumnGroups() {
                var identdata_cnt = 0
                var datadata_cnt = 0
                var metadata_cnt = 0
                $("#advsrchres th").each(function() {
                    if ($(this).is(":visible")) {
                        if ($(this).hasClass("idgrp")) {
                            identdata_cnt = identdata_cnt + 1
                        } else if ($(this).hasClass("datagrp")) {
                            datadata_cnt = datadata_cnt + 1
                        } else if ($(this).hasClass("metagrp")) {
                            metadata_cnt = metadata_cnt + 1
                        }
                    }
                })
                $("#advsrchres .identdata").attr("span", identdata_cnt)
                $("#advsrchres .datadata").attr("span", datadata_cnt)
                $("#advsrchres .metadata").attr("span", metadata_cnt)
            }
        })
    </script>
    <script src="https://cdn.jsdelivr.net/gh/wenzhixin/bootstrap-table-examples@master/utils/natural-sorting/dist/natural-sorting.js"></script>

{% endblock %}
{% block content %}
    <div style="float: right; margin-right: 1rem;" class="buttons-toolbar"></div>
    <table class="table table-hover table-striped table-bordered"
        id="advsrchres"
        data-toggle="table"
        data-buttons-toolbar=".buttons-toolbar"
        data-buttons-class="primary"
        data-buttons-align="right"
        data-filter-control="false"
        data-search="false"
        data-show-search-clear-button="false"
        data-show-multi-sort="true"
        data-show-columns="true"
        data-show-columns-toggle-all="true"
        data-show-fullscreen="false"
        data-show-export="false">

        <colgroup span="8" class="identdata"></colgroup>
        <colgroup span="5" class="datadata"></colgroup>
        <colgroup span="12" class="metadata"></colgroup>

        <thead>
            <tr>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Animal-data-visible' 'false' %}" data-field="Animal">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__name">Animal</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Sample-data-visible' 'true' %}" data-field="Sample" data-switchable="false">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__name">Sample</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Tissue-data-visible' 'true' %}" data-field="Tissue">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__tissue__name">Tissue</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Peak_Group-data-visible' 'false' %}" data-field="Peak_Group">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__name">Peak Group</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Measured_Compounds-data-visible' 'true' %}" data-field="Measured_Compounds">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__compounds__name">Measured<br>Compound(s)</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Measured_Compound_Synonyms-data-visible' 'false' %}" data-field="Measured_Compound_Synonyms">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__compounds__synonyms__name">Measured<br>Compound<br>Synonym(s)</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Labeled_Element_Count-data-visible' 'true' %}" data-field="Labeled_Element_Count">
                    <div onclick="sortColumn(this)" class="sortable" id="labeled_element">Labeled<br>Element:<br></div><div onclick="sortColumn(this)" class="sortable" id="labeled_count">Count</div>
                </th>
                <th data-valign="top" class="idgrp" data-visible="{% get_template_cookie selfmt 'Peak_Group_Set_Filename-data-visible' 'false' %}" data-field="Peak_Group_Set_Filename">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__peak_group_set__filename">Peak Group Set Filename</div>
                </th>

                <th data-valign="top" class="datagrp" data-visible="{% get_template_cookie selfmt 'Raw_Abundance-data-visible' 'false' %}" data-field="Raw_Abundance">
                    <div onclick="sortColumn(this)" class="sortable" id="raw_abundance">Raw<br>Abundance</div>
                </th>
                <th data-valign="top" class="datagrp" data-visible="{% get_template_cookie selfmt 'Corrected_Abundance-data-visible' 'true' %}" data-field="Corrected_Abundance">
                    <div onclick="sortColumn(this)" class="sortable" id="corrected_abundance">Corrected<br>Abundance</div>
                </th>
                <th data-valign="top" class="datagrp" data-visible="{% get_template_cookie selfmt 'Fraction-data-visible' 'true' %}" data-field="Fraction" data-switchable="false">
                    Fraction
                </th>
                <th data-valign="top" class="datagrp" data-visible="{% get_template_cookie selfmt 'Median_MZ-data-visible' 'false' %}" data-field="Median_MZ">
                    <div onclick="sortColumn(this)" class="sortable" id="med_mz">Median<br>M/Z</div>
                </th>
                <th data-valign="top" class="datagrp" data-visible="{% get_template_cookie selfmt 'Median_RT-data-visible' 'false' %}" data-field="Median_RT">
                    <div onclick="sortColumn(this)" class="sortable" id="med_rt">Median<br>RT</div>
                </th>

                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Formula-data-visible' 'false' %}" data-field="Formula">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__formula">Formula</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Genotype-data-visible' 'true' %}" data-field="Genotype">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__genotype">Genotype</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Sex-data-visible' 'false' %}" data-field="Sex">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__sex">Sex</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Age-data-visible' 'false' %}" data-field="Age">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__age">Age<br>(weeks)</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Body_Weight-data-visible' 'false' %}" data-field="Body_Weight">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__body_weight">Body<br>Weight<br>(g)</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Feeding_Status-data-visible' 'true' %}" data-field="Feeding_Status">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__feeding_status">Feeding<br>Status</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Treatment-data-visible' 'true' %}" data-field="Treatment">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__treatment__name">Treatment</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Diet-data-visible' 'false' %}" data-field="Diet">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__diet">Diet</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Tracer_Compound-data-visible' 'true' %}" data-field="Tracer_Compound" data-switchable="false">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__tracer_compound__name">Tracer<br>Compound</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Tracer_Infusion_Rate-data-visible' 'false' %}" data-field="Tracer_Infusion_Rate">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__tracer_infusion_rate">Tracer<br>Infusion<br>Rate<br>(ul/min/g)</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Tracer_Infusion_Concentration-data-visible' 'false' %}" data-field="Tracer_Infusion_Concentration">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__tracer_infusion_concentration">Tracer<br>Infusion<br>Concentration<br>(mM)</div>
                </th>
                <th data-valign="top" class="metagrp" data-visible="{% get_template_cookie selfmt 'Study-data-visible' 'true' %}" data-field="Study">
                    <div onclick="sortColumn(this)" class="sortable" id="peak_group__msrun__sample__animal__studies__name">Studies</div>
                </th>
            </tr>
        </thead>

        <tbody>
            {% for pd in res.all %}
                <tr>
                    <!-- Animal -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">{{ pd.peak_group.msrun.sample.animal.name }}</div>
                        <a href="{% url 'animal_detail' pd.peak_group.msrun.sample.animal.id %}">
                            {{ pd.peak_group.msrun.sample.animal.name }}
                        </a>
                    </td>

                    <!-- Sample -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">{{ pd.peak_group.msrun.sample.name }}</div>
                        <div class="nobr">
                            <a href="{% url 'sample_detail' pd.peak_group.msrun.sample.id %}">
                                {{ pd.peak_group.msrun.sample.name }}
                            </a>
                        </div>
                    </td>

                    <!-- Tissue -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">{{ pd.peak_group.msrun.sample.tissue.name }}</div>
                        <a href="{% url 'tissue_detail' pd.peak_group.msrun.sample.tissue.id %}">
                            {{ pd.peak_group.msrun.sample.tissue.name }}
                        </a>
                    </td>

                    <!-- Peak Group -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">{{ pd.peak_group.name }}</div>
                        <a href="{% url 'peakgroup_detail' pd.peak_group.id %}">
                            {{ pd.peak_group.name }}
                        </a>
                    </td>

                    <!-- Measured Compound(s) -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">
                            {% define True as cpdfirst %}
                            {% for mcpd in pd.peak_group.compounds.all %}{% if not cpdfirst %}; {% endif%}{{ mcpd.name }}{% define False as cpdfirst %}{% endfor %}
                        </div>

                        {% define True as cpdfirst %}
                        {% for mcpd in pd.peak_group.compounds.all %}{% if not cpdfirst %}; {% endif%}<a href="{% url 'compound_detail' mcpd.id %}">{{ mcpd.name }}</a>{% define False as cpdfirst %}{% endfor %}
                    </td>

                    <!-- Measured Compound Synonym(s) -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">
                            {% define True as cpdfirst %}
                            {% for mcpd in pd.peak_group.compounds.all %}{% if not cpdfirst %}; {% endif%}{% define True as synfirst %}{% get_case_insensitive_synonyms mcpd.synonyms as inssyns %}{% for mcpdsyn in inssyns %}{% if not synfirst %}/{% endif%}{{ mcpdsyn }}{% define False as synfirst %}{% endfor %}{% define False as cpdfirst %}{% endfor %}
                        </div>

                        {% define True as cpdfirst %}
                        {% for mcpd in pd.peak_group.compounds.all %}{% if not cpdfirst %}; {% endif%}<a href="{% url 'compound_detail' mcpd.id %}">{% define True as synfirst %}{% get_case_insensitive_synonyms mcpd.synonyms as inssyns %}{% for mcpdsyn in inssyns %}{% if not synfirst %}/{% endif%}{{ mcpdsyn }}{% define False as synfirst %}{% endfor %}</a>{% define False as cpdfirst %}{% endfor %}
                    </td>

                    <!-- Labeled Element:Count -->
                    <td>
                        {{ pd.labeled_element }}:{{ pd.labeled_count }}
                    </td>

                    <!-- Peak Group Set Filename -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">{{ pd.peak_group.peak_group_set.filename }}</div>
                        <a href="{% url 'peakgroupset_detail' pd.peak_group.peak_group_set.id %}">
                            {{ pd.peak_group.peak_group_set.filename }}
                        </a>
                    </td>

                    <!-- Raw Abundance -->
                    <td class="text-end">
                        <p title="{{ pd.raw_abundance|floatformat:10 }}">{{ pd.raw_abundance|floatformat:1 }}</p>
                    </td>

                    <!-- Corrected Abundance -->
                    <td class="text-end">
                        <p title="{{ pd.corrected_abundance|floatformat:10 }}">{{ pd.corrected_abundance|floatformat:1 }}</p>
                    </td>

                    <!-- Fraction -->
                    <td class="text-end">
                        <p title="{{ pd.fraction|floatformat:15 }}">{{ pd.fraction|floatformat:4 }}</p>
                    </td>

                    <!-- Median M/Z -->
                    <td class="text-end">
                        <p title="{{ pd.med_mz|floatformat:10 }}">{{ pd.med_mz|floatformat:1 }}</p>
                    </td>

                    <!-- Median RT -->
                    <td class="text-end">
                        <p title="{{ pd.med_rt|floatformat:10 }}">{{ pd.med_rt|floatformat:1 }}</p>
                    </td>

                    <!-- Formula -->
                    <td>
                        {{ pd.peak_group.formula }}
                    </td>

                    <!-- Genotype -->
                    <td>
                        {{ pd.peak_group.msrun.sample.animal.genotype }}
                    </td>

                    <!-- Sex -->
                    <td>
                        {{ pd.peak_group.msrun.sample.animal.sex }}
                    </td>

                    <!-- Age (weeks) -->
                    <td class="text-end">
                        <p title="{{ pd.peak_group.msrun.sample.animal.age }} (d-hh:mm:ss)">{{ pd.peak_group.msrun.sample.animal.age|durationToWeeks|decimalPlaces:2 }}</p>
                    </td>

                    <!-- Body Weight (g) -->
                    <td>
                        {{ pd.peak_group.msrun.sample.animal.body_weight }}
                    </td>

                    <!-- Feeding Status -->
                    <td>
                        {{ pd.peak_group.msrun.sample.animal.feeding_status }}
                    </td>

                    <!-- Treatment -->
                    <td>
                        {% if pd.peak_group.msrun.treatment.name is None %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">None</div>
                            <p title="Animal has no treatment.">None</p>
                        {% else %}
                            {{ pd.peak_group.msrun.treatment.name }}
                        {% endif %}
                    </td>

                    <!-- Diet -->
                    <td>
                        {{ pd.peak_group.msrun.sample.animal.diet }}
                    </td>

                    <!-- Tracer Compound -->
                    <td>
                        {% if pd.peak_group.msrun.sample.animal.tracer_compound is None %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">None</div>
                            <p title="Animal has no tracer.">None</p>
                        {% else %}
                            <!-- Put displayed link text first for sorting -->
                            <div style="display:none;">{{ pd.peak_group.msrun.sample.animal.tracer_compound.name }}</div>
                            <a href="{% url 'compound_detail' pd.peak_group.msrun.sample.animal.tracer_compound.id %}">
                                {{ pd.peak_group.msrun.sample.animal.tracer_compound.name }}
                            </a>
                        {% endif %}
                    </td>

                    <!-- Tracer Infusion Rate (ul/min/g) -->
                    <td class="text-end">
                        {{ pd.peak_group.msrun.sample.animal.tracer_infusion_rate }}
                    </td>

                    <!-- Tracer Infusion Concentration (mM) -->
                    <td class="text-end">
                        {{ pd.peak_group.msrun.sample.animal.tracer_infusion_concentration }}
                    </td>

                    <!-- Studies -->
                    <td>
                        <!-- Put displayed link text first for sorting -->
                        <div style="display:none;">
                            {% define True as first %}
                            {% for study in pd.peak_group.msrun.sample.animal.studies.all %}{% if not first %},<br>{% endif%}{{ study.name }}{% define False as first %}{% endfor %}
                        </div>

                        {% define True as first %}
                        {% for study in pd.peak_group.msrun.sample.animal.studies.all %}{% if not first %},<br>{% endif%}<a href="{% url 'study_detail' study.id %}">{{ study.name }}</a>{% define False as first %}{% endfor %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
