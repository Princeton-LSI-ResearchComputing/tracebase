{% load customtags %}
<script>
    document.addEventListener("DOMContentLoaded", function(){
        const real_cnt_elem = document.getElementById("realcount")
        const rec_cnt = real_cnt_elem.innerHTML
        const rec_cnt_elem = document.getElementById("recordcount")
        rec_cnt_elem.innerHTML = rec_cnt
    })
</script>
{% block content %}
    <h3 style="margin: 0; display: inline-block;">{{ qry|getFormatName:selfmt }} Results (<span id="recordcount">{{ res.count|default:"0" }}</span> Rows)</h3>
    <table class="table table-success table-hover table-striped table-bordered">
        <tr>
            <th>Sample</th>
            <th>Tissue</th>
            <th>Peak Group</th>
            <th>Formula</th>
            <th>Labeled Element:Count</th>
            <th>Raw Abundance</th>
            <th>Corrected Abundance</th>
            <th>Fraction</th>
            <th>Median M/Z</th>
            <th>Median RT</th>
            <th>Peak Group Set Filename</th>
            <th>Animal</th>
            <th>Genotype</th>
            <th>Body Weight (g)</th>
            <th>Age (weeks)</th>
            <th>Sex</th>
            <th>Diet</th>
            <th>Feeding Status</th>
            <th>Treatment</th>
            <th>Tracer Compound</th>
            <th>Tracer Infusion Rate (ul/min/g)</th>
            <th>Tracer Infusion Concentration (mM)</th>
            <th>Study</th>
        </tr>

        {% createCounter as rec_cnt %}

        {% for pd in res.all %}

            {# Initialize a new dict used for many-to-many related table refiltering #}
            {% createDict as mm_lookup %}

            {% for study in pd.peak_group.msrun.sample.animal.studies.all %}

                {# Add the M:M model key path as a key pointing to its current record to the mm_lookup dict #}
                {# This way of looking up M:M record values is necessary to support multiple M:M related models in a composite view #}
                {% addToDict mm_lookup "peak_group__msrun__sample__animal__studies" study %}

                {# At the most nested loop level, we have enough info to refilter for unmatching many-to-many records #}
                {% shouldKeepManyToMany pg mm_lookup qry refilter as keep %}

                {% if keep %}
                    {% incrementCounter rec_cnt %}

                    <tr>
                        <!-- Sample -->
                        <td>
                            <div class="nobr">
                                <a href="{% url 'sample_detail' pd.peak_group.msrun.sample.id %}">
                                    {{ pd.peak_group.msrun.sample.name }}
                                </a>
                            </div>
                        </td>

                        <!-- Tissue -->
                        <td>
                            {{ pd.peak_group.msrun.sample.tissue.name }}
                        </td>

                        <!-- Peak Group -->
                        <td>
                            <a href="{% url 'peakgroup_detail' pd.peak_group.id %}">
                                {{ pd.peak_group.name }}
                            </a>
                        </td>

                        <!-- Formula -->
                        <td>
                            {{ pd.peak_group.formula }}
                        </td>

                        <!-- Labeled Element:Count -->
                        <td>
                            {{ pd.labeled_element }}:{{ pd.labeled_count }}
                        </td>

                        <!-- Raw Abundance -->
                        <td class="text-end">
                            <p title="{{ pd.raw_abundance }}">{{ pd.raw_abundance|floatformat:1 }}</p>
                        </td>

                        <!-- Corrected Abundance -->
                        <td class="text-end">
                            <p title="{{ pd.corrected_abundance }}">{{ pd.corrected_abundance|floatformat:1 }}</p>
                        </td>

                        <!-- Fraction -->
                        <td class="text-end">
                            <p title="{{ pd.fraction }}">{{ pd.fraction|floatformat:4 }}</p>
                        </td>

                        <!-- Median M/Z -->
                        <td class="text-end">
                            <p title="{{ pd.med_mz }}">{{ pd.med_mz|floatformat:1 }}</p>
                        </td>

                        <!-- Median RT -->
                        <td class="text-end">
                            <p title="{{ pd.med_rt }}">{{ pd.med_rt|floatformat:1 }}</p>
                        </td>

                        <!-- Peak Group Set Filename -->
                        <td>
                            <a href="{% url 'peakgroupset_detail' pd.peak_group.peak_group_set.id %}">
                                {{ pd.peak_group.peak_group_set.filename }}
                            </a>
                        </td>

                        <!-- Animal -->
                        <td>
                            <a href="{% url 'animal_detail' pd.peak_group.msrun.sample.animal.id %}">
                                {{ pd.peak_group.msrun.sample.animal.name }}
                            </a>
                        </td>

                        <!-- Genotype -->
                        <td>
                            {{ pd.peak_group.msrun.sample.animal.genotype }}
                        </td>

                        <!-- Body Weight (g) -->
                        <td>
                            {{ pd.peak_group.msrun.sample.animal.body_weight }}
                        </td>

                        <!-- Age (weeks) -->
                        <td class="text-end">
                            <p title="{{ pd.peak_group.msrun.sample.animal.age }} (d-hh:mm:ss)">{{ pd.peak_group.msrun.sample.animal.age|durationToWeeks|decimalPlaces:2 }}</p>
                        </td>

                        <!-- Sex -->
                        <td>
                            {{ pd.peak_group.msrun.sample.animal.sex }}
                        </td>

                        <!-- Diet -->
                        <td>
                            {{ pd.peak_group.msrun.sample.animal.diet }}
                        </td>

                        <!-- Feeding Status -->
                        <td>
                            {{ pd.peak_group.msrun.sample.animal.feeding_status }}
                        </td>

                        <!-- Treatment -->
                        <td>
                            {{ pd.peak_group.msrun.treatment.name }}
                        </td>

                        <!-- Tracer Compound -->
                        <td>
                            <a href="{% url 'compound_detail' pd.peak_group.msrun.sample.animal.tracer_compound.id %}">
                                {{ pd.peak_group.msrun.sample.animal.tracer_compound.name }}
                            </a>
                        </td>

                        <!-- Tracer Infusion Rate (ul/min/g) -->
                        <td class="text-end">
                            {{ pd.peak_group.msrun.sample.animal.tracer_infusion_rate }}
                        </td>

                        <!-- Tracer Infusion Concentration (mM) -->
                        <td class="text-end">
                            {{ pd.peak_group.msrun.sample.animal.tracer_infusion_concentration }}
                        </td>

                        <!-- Study -->
                        <td>
                            <a href="{% url 'study_detail' study.id %}">
                                {{ study.name }}
                            </a>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </table>
    <div id="realcount" style="display:none;">{% getCount rec_cnt %}</div>
{% endblock %}
