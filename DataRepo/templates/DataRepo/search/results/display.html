{% load customtags %}
{% block content %}
    <div>
        {% define True as valid_search %}
        {% define default_format as selfmt %}
        {% if mode == "search" %}
            {% if qry %}
                {% if qry.selectedtemplate in forms.keys %}
                    {% define forms|index:qry.selectedtemplate as selfrm %}
                    {% if not valid_search or selfrm.0.val == "" or selfrm.0.val.errors %}
                        {% define False as valid_search %}
                    {% else %}
                        {% define qry.selectedtemplate as selfmt %}
                    {% endif %}
                {% else %}
                    {% define False as valid_search %}
                {% endif %}
            {% endif %}
        {% else %}
            {% if format in forms.keys %}
                {% define format as selfmt %}
            {% else %}
                {% define False as valid_search %}
            {% endif %}
        {% endif %}

        {% if res %}
            <hr>

            {% if valid_search %}
                <div style="float: right;">
                    <form action="/DataRepo/search_advanced_tsv/" id="advanced-search-download-form" method="POST">
                        {% csrf_token %}
                        {{ download_form.qryjson }}
                        <button type="submit" class="btn btn-primary mb-2" id="advanced-download-submit" title="Export data"><i class="fa fa-download"></i></button>
                        <!-- There are multiple form types, but we only need one set of form management inputs. We can get away with this because all the fields are the same. -->
                        {{ download_form.management_form }}
                    </form>
                </div>

                {% if selfmt == "pgtemplate" %}
                    {% include "DataRepo/search/results/peakgroups.html" with selfmt=selfmt %}
                {% elif selfmt == "pdtemplate" %}
                    {% include "DataRepo/search/results/peakdata.html" with selfmt=selfmt %}
                {% elif selfmt == "fctemplate" %}
                    {% include "DataRepo/search/results/fcirc.html" with selfmt=selfmt %}
                {% endif %}
            {% else %}
                <label class="text-danger">Invalid format: {{ selfmt }}</label>
            {% endif %}

        {% else %}
            {% if valid_search and mode == "browse" or qry %}
                <hr>
                <p>No matching records found.</p>
            {% endif %}
            {# 'else' is just the search forms #}
        {% endif %}
    </div>

{% endblock %}
