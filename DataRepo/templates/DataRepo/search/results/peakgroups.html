{% load customtags %}
{% block head_extras %}

    <script>
        // Correct the row count to account for M:M related tables
        document.addEventListener("DOMContentLoaded", function(){
            const real_cnt_elem = document.getElementById("realcount")
            const real_cnt = real_cnt_elem.innerHTML
            const rec_cnt_elem = document.getElementById("recordcount")
            rec_cnt_elem.innerHTML = real_cnt

            // https://bootstrap-table.com/docs/api/events/
            // https://bootstrap-table.com/docs/api/events/#oncolumnswitch
            $("#advsrchres").bootstrapTable({
                onAll: function() {
                    updateColumnGroups()
                }
            })

            function updateColumnGroups() {
                var identdata_cnt = 0
                var datadata_cnt = 0
                var metadata_cnt = 0
                $("#advsrchres th").each(function() {
                    if ($(this).is(":visible")) {
                        if ($(this).hasClass("idgrp")) {
                            identdata_cnt = identdata_cnt + 1
                        } else if ($(this).hasClass("datagrp")) {
                            datadata_cnt = datadata_cnt + 1
                        } else if ($(this).hasClass("metagrp")) {
                            metadata_cnt = metadata_cnt + 1
                        }
                    }
                })
                $("#advsrchres .identdata").attr("span", identdata_cnt)
                $("#advsrchres .datadata").attr("span", datadata_cnt)
                $("#advsrchres .metadata").attr("span", metadata_cnt)
            }
        })
    </script>
    <script src="https://cdn.jsdelivr.net/gh/wenzhixin/bootstrap-table-examples@master/utils/natural-sorting/dist/natural-sorting.js"></script>

{% endblock %}
{% block content %}
    <div style="float: right; margin-right: 1rem;" class="buttons-toolbar"></div>
    <h3>{{ qry|getFormatName:selfmt }} Results (<span id="recordcount">{{ res.count|default:"0" }}</span> Rows)</h3>
    <table class="table table-hover table-striped table-bordered"
        id="advsrchres"
        data-toggle="table"
        data-buttons-toolbar=".buttons-toolbar"
        data-buttons-class="primary"
        data-buttons-align="right"
        data-filter-control="false"
        data-search="false"
        data-show-search-clear-button="false"
        data-show-multi-sort="true"
        data-show-columns="true"
        data-show-columns-toggle-all="true"
        data-show-fullscreen="false"
        data-show-export="false"
        data-pagination="true">

        <colgroup span="8" class="identdata"></colgroup>
        <colgroup span="4" class="datadata"></colgroup>
        <colgroup span="12" class="metadata"></colgroup>

        <thead>
            <tr>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Animal" class="idgrp">Animal</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Sample" class="idgrp" data-switchable="false">Sample</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Tissue" class="idgrp">Tissue</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Peak_Group" class="idgrp">Peak Group</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Compound_Name" class="idgrp">Measured<br>Compound</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Compound_Synonym" class="idgrp">Measured<br>Compound<br>Synonym(s)</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Labeled_Element" class="idgrp">Labeled<br>Element</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Peak_Group_Set_Filename" class="idgrp">Peak Group Set Filename</th>

                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="numericOnly" data-field="Total_Abundance" class="datagrp" data-switchable="false">Total<br>Abundance</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="numericOnly" data-field="Enrichment_Fraction" class="datagrp">Enrichment<br>Fraction</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="numericOnly" data-field="Enrichment_Abundance" class="datagrp">Enrichment<br>Abundance</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="numericOnly" data-field="Normalized_Labeling" class="datagrp">Normalized<br>Labeling</th>

                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Formula" class="metagrp">Formula</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Genotype" class="metagrp">Genotype</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Sex" class="metagrp">Sex</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Feeding_Status" class="metagrp">Feeding<br>Status</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Diet" class="metagrp">Diet</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Treatment" class="metagrp">Treatment</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="numericOnly" data-field="Body_Weight" class="metagrp">Body<br>Weight<br>(g)</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="alphanum" data-field="Age" class="metagrp">Age<br>(weeks)</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Tracer_Compound" class="metagrp" data-switchable="false">Tracer<br>Compound</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="numericOnly" data-field="Tracer_Infusion_Rate" class="metagrp">Tracer<br>Infusion<br>Rate<br>(ul/min/g)</th>
                <th data-valign="top" data-sortable="true" data-visible="false" data-sorter="numericOnly" data-field="Tracer_Infusion_Concentration" class="metagrp">Tracer<br>Infusion<br>Concentration<br>(mM)</th>
                <th data-valign="top" data-sortable="true" data-visible="true" data-sorter="alphanum" data-field="Study" class="metagrp">Study</th>
            </tr>
        </thead>

        <tbody>

            {% createCounter as rec_cnt %}

            {% for pg in res.all %}

                {# Initialize a new dict used for many-to-many related table refiltering. This way of looking up M:M record values is necessary to support multiple M:M related models in a composite view #}
                {# Add each M:M model key path as a key pointing to its current record to the mm_lookup dict #}
                {% createDict as mm_lookup %}

                {# Keep track of what record combos we're keeping or refiltering with a dict holding a boolean [keeping.keep] (because a single boolean value has some sort of scoping issue) #}
                {% createDict as keeping %}

                {% for study in pg.msrun.sample.animal.studies.all %}

                    {% addToDict mm_lookup "msrun__sample__animal__studies" study %}
                    {% addToDict keeping "keep" False %}

                    {% for cs in pg.compounds.all %}

                        {% addToDict mm_lookup "compounds" cs %}

                        {% for ss in cs.synonyms.all %}

                            {% addToDict mm_lookup "compounds__synonyms" ss %}

                            {% if not keeping.keep %}

                                {# At the most nested loop level, we have enough info to refilter for unmatching many-to-many records #}
                                {% shouldKeepManyToMany pg mm_lookup qry refilter as keep %}

                                {# I don't know why changes to keep don't make it outside the loop, but saving it in a dict works #}
                                {% addToDict keeping "keep" keep %}

                            {% endif %}

                        {% endfor %}
                    {% endfor %}

                    {% if keeping.keep %}

                        {% incrementCounter rec_cnt %}

                        <tr>
                            <!-- Animal -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">{{ pg.msrun.sample.animal.name }}</div>
                                <a href="{% url 'animal_detail' pg.msrun.sample.animal.id %}">
                                    {{ pg.msrun.sample.animal.name }}
                                </a>
                            </td>

                            <!-- Sample -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">{{ pg.msrun.sample.name }}</div>
                                <div class="nobr">
                                    <a href="{% url 'sample_detail' pg.msrun.sample.id %}">
                                        {{ pg.msrun.sample.name }}
                                    </a>
                                </div>
                            </td>

                            <!-- Tissue -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">{{ pg.msrun.sample.tissue.name }}</div>
                                <a href="{% url 'tissue_detail' pg.msrun.sample.tissue.id %}">
                                    {{ pg.msrun.sample.tissue.name }}
                                </a>
                            </td>

                            <!-- Peak Group -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">{{ pg.name }}</div>
                                <a href="{% url 'peakgroup_detail' pg.id %}">
                                    {{ pg.name }}
                                </a>
                            </td>

                            <!-- Measured Compound -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">
                                    {% define True as cpdfirst %}
                                    {% for mcpd in pg.compounds.all %}{% if not cpdfirst %}; {% endif%}{{ mcpd.name }}{% define False as cpdfirst %}{% endfor %}
                                </div>

                                {% define True as cpdfirst %}
                                {% for mcpd in pg.compounds.all %}{% if not cpdfirst %}; {% endif%}<a href="{% url 'compound_detail' mcpd.id %}">{{ mcpd.name }}</a>{% define False as cpdfirst %}{% endfor %}
                            </td>

                            <!-- Measured Compound Synonym(s) -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">
                                    {% define True as cpdfirst %}
                                    {% for mcpd in pg.compounds.all %}{% if not cpdfirst %}; {% endif%}{% define True as synfirst %}{% get_case_insensitive_synonyms mcpd.synonyms as inssyns %}{% for mcpdsyn in inssyns %}{% if not synfirst %}/{% endif%}{{ mcpdsyn }}{% define False as synfirst %}{% endfor %}{% define False as cpdfirst %}{% endfor %}
                                </div>

                                {% define True as cpdfirst %}
                                {% for mcpd in pg.compounds.all %}{% if not cpdfirst %}; {% endif%}<a href="{% url 'compound_detail' mcpd.id %}">{% define True as synfirst %}{% get_case_insensitive_synonyms mcpd.synonyms as inssyns %}{% for mcpdsyn in inssyns %}{% if not synfirst %}/{% endif%}{{ mcpdsyn }}{% define False as synfirst %}{% endfor %}</a>{% define False as cpdfirst %}{% endfor %}
                            </td>

                            <!-- Labeled Element -->
                            <td>
                                {{ pg.msrun.sample.animal.tracer_labeled_atom }}
                            </td>

                            <!-- Peak Group Set Filename -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">{{ pg.peak_group_set.filename }}</div>
                                <a href="{% url 'peakgroupset_detail' pg.peak_group_set.id %}">
                                    {{ pg.peak_group_set.filename }}
                                </a>
                            </td>

                            <!-- Total Abundance -->
                            <td class="text-end">
                                <p title="{{ pg.total_abundance|floatformat:10 }}">{{ pg.total_abundance|floatformat:1 }}</p>
                            </td>

                            <!-- Enrichment Fraction -->
                            <td class="text-end">
                                <p title="{{ pg.enrichment_fraction|floatformat:15 }}">{{ pg.enrichment_fraction|floatformat:4 }}</p>
                            </td>

                            <!-- Enrichment Abundance -->
                            <td class="text-end">
                                <p title="{{ pg.enrichment_abundance|floatformat:10 }}">{{ pg.enrichment_abundance|floatformat:4 }}</p>
                            </td>

                            <!-- Normalized Labeling -->
                            <td class="text-end">
                                {% if pg.normalized_labeling is None %}
                                    <p title="PeakGroup, serum sample, or Animal Tracer not found.">None</p>
                                {% else %}
                                    <p title="{{ pg.normalized_labeling|floatformat:15 }}">{{ pg.normalized_labeling|floatformat:4 }}</p>
                                {% endif %}
                            </td>

                            <!-- Formula -->
                            <td>
                                {{ pg.formula }}
                            </td>

                            <!-- Genotype -->
                            <td>
                                {{ pg.msrun.sample.animal.genotype }}
                            </td>

                            <!-- Sex -->
                            <td>
                                {{ pg.msrun.sample.animal.sex }}
                            </td>

                            <!-- Feeding Status -->
                            <td>
                                {{ pg.msrun.sample.animal.feeding_status }}
                            </td>

                            <!-- Diet -->
                            <td>
                                {{ pg.msrun.sample.animal.diet }}
                            </td>

                            <!-- Treatment -->
                            <td>
                                {% if pg.msrun.sample.animal.treatment is None %}
                                    None
                                {% else %}
                                    <!-- Put displayed link text first for sorting -->
                                    <div style="display:none;">{{ pg.msrun.sample.animal.treatment.name }}</div>

                                    <a href="{% url 'protocol_detail' pg.msrun.sample.animal.treatment.id %}">
                                        {{ pg.msrun.sample.animal.treatment.name }}
                                    </a>
                                {% endif %}
                            </td>

                            <!-- Body Weight (g) -->
                            <td class="text-end">
                                {{ pg.msrun.sample.animal.body_weight }}
                            </td>

                            <!-- Age (weeks) -->
                            <td class="text-end">
                                <p title="{{ pg.msrun.sample.animal.age }} (d-hh:mm:ss)">{{ pg.msrun.sample.animal.age|durationToWeeks|decimalPlaces:2 }}</p>
                            </td>

                            <!-- Tracer Compound -->
                            <td>
                                {% if pg.msrun.sample.animal.tracer_compound is None %}
                                    <!-- Put displayed link text first for sorting -->
                                    <div style="display:none;">None</div>
                                    <p title="Animal has no tracer.">None</p>
                                {% else %}
                                    <!-- Put displayed link text first for sorting -->
                                    <div style="display:none;">{{ pg.msrun.sample.animal.tracer_compound.name }}</div>
                                    <a href="{% url 'compound_detail' pg.msrun.sample.animal.tracer_compound.id %}">
                                        {{ pg.msrun.sample.animal.tracer_compound.name }}
                                    </a>
                                {% endif %}
                            </td>

                            <!-- Tracer Infusion Rate (ul/min/g) -->
                            <td class="text-end">
                                {{ pg.msrun.sample.animal.tracer_infusion_rate }}
                            </td>

                            <!-- Tracer Infusion Concentration (mM) -->
                            <td class="text-end">
                                {{ pg.msrun.sample.animal.tracer_infusion_concentration }}
                            </td>

                            <!-- Study -->
                            <td>
                                <!-- Put displayed link text first for sorting -->
                                <div style="display:none;">{{ study.name }}</div>
                                <a href="{% url 'study_detail' study.id %}">
                                    {{ study.name }}
                                </a>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    <div id="realcount" style="display:none;">{% getCount rec_cnt %}</div>
{% endblock %}
