{% extends "base.html" %}
{% load static %}
{% load advsrch_tags %}

{% block head_extras %}
    {{ block.super }}
    <script src="{% static 'js/jquery-3.6.0.js' %}"></script>
    <script src="{% static 'js/django-dynamic-formset-1.2.2/jquery.formset.js' %}"></script>
    <script>
        $(function() {
            $('#advsrchpg li').formset({
                addText: '<img src="{% static "images/plus.png" %}" />',
                deleteText: '<img src="{% static "images/minus.png" %}" />'
            });
        })
    </script>
{% endblock %}

{% block content %}
    <div>
        <h3>Advanced Peak Groups Search</h3>
        <form action="" method="POST">
            {% csrf_token %}
            <table>
                <tr>
                    <td>
                        <!-- Changed to an unordered list to try and prepare for nested groups -->
                        <ul id="advsrchpg">
                            {% for f in form %}
                                <li class="list-unstyled">
                                    {{ f.fld }}
                                    {{ f.ncmp }}
                                    {{ f.val }}
                                    <label class="text-danger"> {{ f.val.errors }} </label>
                                </li>
                            {% endfor %}
                            <!-- This keeps the form looking nice if there's an error -->
                            <li class="list-unstyled"></li>
                        </ul>
                    </td>
                    <td class="align-bottom ps-5">
                        {{ form.management_form }}
                        <button type="submit" class="btn btn-primary">Search</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <hr>
    <div>
        <h3>Peak Group Results</h3>
        <!-- Populate the initial (pre-filter/search) view with all records -->
        {% if not res and form.0.val != "" and not form.0.val.errors %}
            {% comment %}
                {% populatePeakGroups res as cur_res %}
            {% endcomment %}
            {% define res as cur_res %}
        {% else %}
            {% define res as cur_res %}
        {% endif %}
        {% if cur_res %}
            <table class="table table-success table-hover table-striped table-bordered">
                <tr>
                    <th>Compound</th>
                    <th>Atom:Label</th>
                    <th>Sample</th>
                    <th>Fraction</th>
                    <th>Tissue</th>
                    <th>Mouse</th>
                    <th>TIC</th>
                    <th>NormFraction</th>
                    <th>Infusate</th>
                    <th>Experiment</th>
                    <th>Feeding Status</th>
                    <th>Infusion Rate</th>
                    <th>[Infusate]</th>
                </tr>

                {% for pd in cur_res.all %}
                    {% for study in pd.peak_group.ms_run.sample.animal.studies.all %}
                        <tr>
                            <!-- Compound -->
                            <td>
                                <!-- TODO: add the view link here when it is added for this model -->
                                <a href="{% url 'sample_detail' pd.peak_group.id %}">
                                    {{ pd.peak_group.name }}
                                </a>
                            </td>

                            <!-- Atom Label -->
                            <td>
                                {{ pd.labeled_element }}:{{ pd.labeled_count }}
                            </td>

                            <!-- Sample -->
                            <td>
                                <div class="nobr">
                                    <!-- TODO: add the view link here when it is added for this model -->
                                    <a href="{% url 'sample_detail' pd.peak_group.ms_run.sample.id %}">
                                        {{ pd.peak_group.ms_run.sample.name }}
                                    </a>
                                </div>
                            </td>

                            <!-- Fraction -->
                            <td class="text-end">
                                <p title="{{ pd.fraction }}">{{ pd.fraction|floatformat:4 }}</p>
                            </td>

                            <!-- Tissue -->
                            <td>
                                {{ pd.peak_group.ms_run.sample.tissue.name }}
                            </td>

                            <!-- Mouse -->
                            <td>
                                <!-- TODO: add the view link here when it is added for this model -->
                                <a href="{% url 'animal_detail' pd.peak_group.ms_run.sample.animal.id %}">
                                    {{ pd.peak_group.ms_run.sample.animal.name }}
                                </a>
                            </td>

                            <!-- TIC -->
                            <td class="text-end">
                                <p title="{{ pd.peak_group.total_abundance }}">{{ pd.peak_group.total_abundance|floatformat:1 }}</p>
                            </td>

                            <!-- NormFraction -->
                            <td class="text-end">
                                <p title="{{ pd.peak_group.normalized_labeling }}">{{ pd.peak_group.normalized_labeling|floatformat:4 }}</p>
                            </td>

                            <!-- Infusate -->
                            <td>
                                {{ pd.peak_group.ms_run.sample.animal.tracer_compound.name }}
                            </td>

                            <!-- Experiment -->
                            <td>
                                <a href="{% url 'study_detail' study.id %}">
                                    {{ study.name }}
                                </a>
                            </td>

                            <!-- Feeding Status -->
                            <td>
                                {{ pd.peak_group.ms_run.sample.animal.feeding_status }}
                            </td>

                            <!-- Infusion Rate -->
                            <td class="text-end">
                                {{ pd.peak_group.ms_run.sample.animal.tracer_infusion_rate }}
                            </td>

                            <!-- [Infusate] -->
                            <td class="text-end">
                                {{ pd.peak_group.ms_run.sample.animal.tracer_infusion_concentration }}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </table>
        {% else %}
            <p>No PeakGroup data found.<!-- where [{{ qry.mdl }}.{{ qry.fld }}] has a
                match of type [{{ qry.cmp }}] to value [{{ qry.val }}], given the
                table/fields in the {{ qry.fmt }} format. --></p>
        {% endif %}
    </div>
{% endblock %}
